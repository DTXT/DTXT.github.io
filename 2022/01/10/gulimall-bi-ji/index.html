<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="项目笔记, DTXG的世界">
    <meta name="description" content="谷粒商城">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>项目笔记 | DTXG的世界</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 6.0.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="DTXG的世界" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>



   <style>
    body{
       background-image: url(https://cdn.jsdelivr.net/gh/Tokisaki-Galaxy/res/site/medias/background.jpg);
       background-repeat:no-repeat;
       background-size: 100% 100%;
       background-attachment:fixed;
    }
</style>



<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">DTXG的世界</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">DTXG的世界</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('https://img2.baidu.com/it/u=2909068583,1783215639&fm=253&fmt=auto&app=138&f=PNG?w=952&h=500')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">项目笔记</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
		height: 70%;
		overflow: auto;
    }


    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E5%95%86%E5%9F%8E/">
                                <span class="chip bg-color">商城</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E7%AC%94%E8%AE%B0/" class="post-category">
                                笔记
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-01-10
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2022-02-15
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    14k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    58 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1><span id="feign使用">Feign使用</span></h1><p>1、启动类加入注解</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@EnableFeignClients</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"com.lpc.gulimall.member.feign"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//开启feign远程客户端,指定远程调用方法包</span>
</code></pre>
<p>2、建包feign，加入方法</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">"gulimall-coupon"</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//掉远程服务器名或集群名</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CouponFeignService</span> <span class="token punctuation">{</span>
   <span class="token comment" spellcheck="true">//远程服务器url必须一致，还有方法名</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/coupon/coupon/member/list"</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//远程方法全路径</span>
    <span class="token keyword">public</span> R <span class="token function">membercoupons</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h1><span id="nacos配置中心使用">nacos配置中心使用</span></h1><p>1、配置文件==bootstarp.properties==</p>
<p>2、给配置中心添加配置(名字要求：<code>应用名.properties</code>)</p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20211206165706371.png" alt="image-20211206165706371"></p>
<p>也可以指定名字，bootstarp.properties加入</p>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">spring.cloud.nacos.config.name</span><span class="token punctuation">=</span><span class="token attr-value">xxx</span>
</code></pre>
<p>3、需要的类加入注解</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@RefreshScope</span><span class="token comment" spellcheck="true">//动态获取配置中心配置</span>
</code></pre>
<p>4、获取配置<code>@Value(${""})</code></p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${coupon.user.name}"</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> String name<span class="token punctuation">;</span>
<span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${coupon.user.age}"</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> Integer age<span class="token punctuation">;</span>
</code></pre>
<p>==注意如果应用里也有相同配置：配置中心优先==</p>
<h2><span id="细节">细节</span></h2><ol>
<li><p>命名空间：配置隔离</p>
<p>创建多个命名空间</p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20211206170202548.png" alt="image-20211206170202548"></p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20211206171248574.png" alt="image-20211206171248574"></p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20211206171303645.png" alt="image-20211206171303645"></p>
<p>默认：public(保留空间)；默认新增的配置都在public空间</p>
<ol>
<li><p>|开发、测试、生产；</p>
<p>利用命名空间做环境隔离</p>
</li>
<li><p>|多个命名空间多个配置切换？</p>
<p><code>bootstrap.properties</code>加入配置</p>
<pre class=" language-properties"><code class="language-properties"><span class="token comment" spellcheck="true">#获取别的空间的配置，可以指定命名空间，参数是命名空间id</span>
<span class="token attr-name">spring.cloud.nacos.config.namespace</span><span class="token punctuation">=</span><span class="token attr-value">2fa2a9a4-de99-4fd2-9c79-aaea6ec7e1b1</span>
</code></pre>
</li>
<li><p>|每个微服务之间互相隔离配置，每个微服务都创建一个自己的命名空间，只加载自己命名空间的配置</p>
</li>
</ol>
</li>
<li><p>配置集：配置的集合</p>
</li>
<li><p>配置集ID：类似配置文件名</p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20211206171912112.png" alt="image-20211206171912112"></p>
</li>
<li><p>配置集分组*：</p>
<p>默认所有的配置集都属于:DEFAULT_GROUP组；</p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20211206172216252.png" alt="image-20211206172216252"></p>
<p>换组：</p>
<pre class=" language-properties"><code class="language-properties"><span class="token comment" spellcheck="true">#换组 默认default</span>
<span class="token attr-name">spring.cloud.nacos.config.group</span><span class="token punctuation">=</span><span class="token attr-value">111</span>
</code></pre>
</li>
</ol>
<p>==最佳使用：每个微服务创建自己的命名空间，使用配置分组区分环境==</p>
<h2><span id="同时加载多配置集">同时加载多配置集</span></h2><p>配置文件的配置太多比较乱，可以拆分为多个配置文件</p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20211206174105246.png" alt="image-20211206174105246"></p>
<ol>
<li><p>加入配置</p>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">spring.cloud.nacos.config.ext-config[0].data-id</span><span class="token punctuation">=</span><span class="token attr-value">datasource.yml</span>
<span class="token attr-name">spring.cloud.nacos.config.ext-config[0].group</span><span class="token punctuation">=</span><span class="token attr-value">dev</span>
<span class="token comment" spellcheck="true">#动态刷新</span>
<span class="token attr-name">spring.cloud.nacos.config.ext-config[0].refresh</span><span class="token punctuation">=</span><span class="token attr-value">true </span>

<span class="token attr-name">spring.cloud.nacos.config.ext-config[1].data-id</span><span class="token punctuation">=</span><span class="token attr-value">mybatis.yml</span>
<span class="token attr-name">spring.cloud.nacos.config.ext-config[1].group</span><span class="token punctuation">=</span><span class="token attr-value">dev</span>
<span class="token attr-name">spring.cloud.nacos.config.ext-config[1].refresh</span><span class="token punctuation">=</span><span class="token attr-value">true </span>

<span class="token attr-name">spring.cloud.nacos.config.ext-config[2].data-id</span><span class="token punctuation">=</span><span class="token attr-value">other.yml</span>
<span class="token attr-name">spring.cloud.nacos.config.ext-config[2].group</span><span class="token punctuation">=</span><span class="token attr-value">dev</span>
<span class="token attr-name">spring.cloud.nacos.config.ext-config[2].refresh</span><span class="token punctuation">=</span><span class="token attr-value">true </span>
</code></pre>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20211206175009198.png" alt="image-20211206175009198"></p>
</li>
<li><p>测试</p>
<p>发现加载了4个配置，默认会加载1个配置：默认组的<code>应用.properties</code>配置文件</p>
</li>
</ol>
<blockquote>
<p>任何配置文件都可以放入配置中心</p>
<p>只需要在<code>bootstrap.properties</code>文件中指定加载那些即可</p>
</blockquote>
<h1><span id="mp逻辑删除">MP逻辑删除</span></h1><ol>
<li><p>配置全局逻辑删除规则(省)</p>
</li>
<li><p>配置逻辑删除组件Bean(省)</p>
</li>
<li><p>给字段属性加注解@TableLogic</p>
<pre class=" language-JAVA"><code class="language-JAVA">@TableLogic(value="1",delval = "0")
</code></pre>
</li>
</ol>
<h1><span id="跨域问题">跨域问题</span></h1><p>spring提供了类</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> CorsWebFilter <span class="token function">corsWebFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  UrlBasedCorsConfigurationSource source <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UrlBasedCorsConfigurationSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  CorsConfiguration corsConfiguration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CorsConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">// 1、配置跨域</span>
  corsConfiguration<span class="token punctuation">.</span><span class="token function">addAllowedHeader</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  corsConfiguration<span class="token punctuation">.</span><span class="token function">addAllowedMethod</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  corsConfiguration<span class="token punctuation">.</span><span class="token function">addAllowedOrigin</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  corsConfiguration<span class="token punctuation">.</span><span class="token function">setAllowCredentials</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  source<span class="token punctuation">.</span><span class="token function">registerCorsConfiguration</span><span class="token punctuation">(</span><span class="token string">"/**"</span><span class="token punctuation">,</span> corsConfiguration<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CorsWebFilter</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h1><span id="jsr303校验">JSR303校验</span></h1><ol>
<li><p>给bean添加校验注解：javax.validation.constraints，并定义自己的错误信息提示</p>
</li>
<li><p>开启校验：接口参数种加入@Valid注解</p>
<p>校验错误以后会默认响应</p>
</li>
<li><p>给开启校验的参数后，紧跟一个BindingResult，就可以获取到校验的结果</p>
</li>
</ol>
<h2><span id="统一的异常处理">统一的异常处理</span></h2><blockquote>
<p>@ControllerAdvice注解：指定处理一个包下的所有异常</p>
</blockquote>
<p>定义异常信息类</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>lpc<span class="token punctuation">.</span>common<span class="token punctuation">.</span>exception<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 *@author: lpc
 *@date: 9/12/2021 下午 10:17
 *@describe:
 *@vision
 */</span>
<span class="token keyword">public</span> <span class="token keyword">enum</span> BizCodeEnum <span class="token punctuation">{</span>
  <span class="token function">UNKNOW_EXCEPTION</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">,</span> <span class="token string">"系统位置异常"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">VAILD_EXCEPTION</span><span class="token punctuation">(</span><span class="token number">10001</span><span class="token punctuation">,</span> <span class="token string">"参数格式校验失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> code<span class="token punctuation">;</span>
    <span class="token keyword">private</span> String msg<span class="token punctuation">;</span>

    <span class="token function">BizCodeEnum</span><span class="token punctuation">(</span><span class="token keyword">int</span> code<span class="token punctuation">,</span>String msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> code<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>msg <span class="token operator">=</span> msg<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> code<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">public</span> String <span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> msg<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<blockquote>
<p>统一处理异常</p>
</blockquote>
<pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>lpc<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>product<span class="token punctuation">.</span>exception<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>lpc<span class="token punctuation">.</span>common<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>BizCodeEnum<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>lpc<span class="token punctuation">.</span>common<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>R<span class="token punctuation">;</span>
<span class="token keyword">import</span> lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span>Slf4j<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>validation<span class="token punctuation">.</span>BindingResult<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>MethodArgumentNotValidException<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>ControllerAdvice<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>ExceptionHandler<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>RestController<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>RestControllerAdvice<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>HashMap<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * @author: lpc
 * @date: 9/12/2021 下午 9:51
 * @describe:
 * @vision
 */</span>
<span class="token comment" spellcheck="true">// 集中处理异常</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RestControllerAdvice</span><span class="token punctuation">(</span><span class="token string">"com.lpc.gulimall.product.controller"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GulimallExceptionController</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">//精确匹配</span>
  <span class="token annotation punctuation">@ExceptionHandler</span><span class="token punctuation">(</span>value <span class="token operator">=</span> MethodArgumentNotValidException<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> R <span class="token function">handleVaildException</span><span class="token punctuation">(</span>MethodArgumentNotValidException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"数据校验出现问题{},异常类型:{}"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    BindingResult result <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">getBindingResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    HashMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span>String<span class="token operator">></span> errorMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span>String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result
        <span class="token punctuation">.</span><span class="token function">getFieldErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>
            <span class="token punctuation">(</span>fieldError<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
              errorMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>fieldError<span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fieldError<span class="token punctuation">.</span><span class="token function">getDefaultMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> R<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>BizCodeEnum<span class="token punctuation">.</span>VAILD_EXCEPTION<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> BizCodeEnum<span class="token punctuation">.</span>VAILD_EXCEPTION<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">,</span> errorMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment" spellcheck="true">// 不能精确匹配</span>
  <span class="token annotation punctuation">@ExceptionHandler</span><span class="token punctuation">(</span>value <span class="token operator">=</span> Throwable<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> R <span class="token function">handleException</span><span class="token punctuation">(</span>Throwable throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> R<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>BizCodeEnum<span class="token punctuation">.</span>UNKNOW_EXCEPTION<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> BizCodeEnum<span class="token punctuation">.</span>UNKNOW_EXCEPTION<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2><span id="分组校验功能多场景都复杂校验">分组校验功能(多场景都复杂校验)</span></h2><p>新增两个接口类AddGroups,UpdateGroup用作分组校验的标识符</p>
<p>校验的类和接口，可以指定使用add或update的标识符，实现不同情况下进行不同的校验</p>
<p>比如：校验类使用了add和update，意思是这个属性属于这两个组，需要add和update的标识符校验</p>
<p>​           接口加入了add组的校验，意思是调属性的时候会去校验使用了add组下的属性</p>
<p>简单理解：属性 接口 一样的标识符，我就校验你</p>
<ol>
<li><p>给校验注解标注什么情况需要校验,==不指定group的属性，接口使用分组校验，则不生效==；</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>lpc<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>product<span class="token punctuation">.</span>entity<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>TableId<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>TableName<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>Serializable<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>lpc<span class="token punctuation">.</span>common<span class="token punctuation">.</span>valid<span class="token punctuation">.</span>AddGroup<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>lpc<span class="token punctuation">.</span>common<span class="token punctuation">.</span>valid<span class="token punctuation">.</span>UpdateGroup<span class="token punctuation">;</span>
<span class="token keyword">import</span> lombok<span class="token punctuation">.</span>Data<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>hibernate<span class="token punctuation">.</span>validator<span class="token punctuation">.</span>constraints<span class="token punctuation">.</span>URL<span class="token punctuation">;</span>

<span class="token keyword">import</span> javax<span class="token punctuation">.</span>validation<span class="token punctuation">.</span>constraints<span class="token punctuation">.</span>*<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * 品牌
 * 
 * @author lpc
 * @email lpc@gmail.com
 * @date 2021-12-06 12:34:46
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@TableName</span><span class="token punctuation">(</span><span class="token string">"pms_brand"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BrandEntity</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> 1L<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * 品牌id
     */</span>
    <span class="token annotation punctuation">@NotNull</span><span class="token punctuation">(</span>message <span class="token operator">=</span> <span class="token string">"修改必须指定品牌id"</span><span class="token punctuation">,</span>groups<span class="token operator">=</span><span class="token punctuation">{</span>UpdateGroup<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Null</span><span class="token punctuation">(</span>message<span class="token operator">=</span><span class="token string">"新增id必须为空"</span><span class="token punctuation">,</span>groups<span class="token operator">=</span><span class="token punctuation">{</span>AddGroup<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@TableId</span>
    <span class="token keyword">private</span> Long brandId<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/**
     * 品牌名
     */</span>
    <span class="token annotation punctuation">@NotBlank</span><span class="token punctuation">(</span>message<span class="token operator">=</span><span class="token string">"品牌名必须提交"</span><span class="token punctuation">,</span>groups<span class="token operator">=</span><span class="token punctuation">{</span>AddGroup<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>UpdateGroup<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> String name<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/**
     * 品牌logo地址
     */</span>
    <span class="token annotation punctuation">@NotBlank</span><span class="token punctuation">(</span>groups<span class="token operator">=</span><span class="token punctuation">{</span>AddGroup<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@URL</span><span class="token punctuation">(</span>message<span class="token operator">=</span><span class="token string">"logo必须是一个合法的url地址"</span><span class="token punctuation">,</span>groups<span class="token operator">=</span><span class="token punctuation">{</span>AddGroup<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>UpdateGroup<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> String logo<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/**
     * 介绍
     */</span>
    <span class="token keyword">private</span> String descript<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/**
     * 显示状态[0-不显示；1-显示]
     */</span>
    <span class="token keyword">private</span> Integer showStatus<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/**
     * 检索首字母
     */</span>
    <span class="token annotation punctuation">@NotEmpty</span><span class="token punctuation">(</span>groups<span class="token operator">=</span><span class="token punctuation">{</span>AddGroup<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Pattern</span><span class="token punctuation">(</span>regexp <span class="token operator">=</span> <span class="token string">"/^[a-zA-Z]$/"</span><span class="token punctuation">,</span>message<span class="token operator">=</span><span class="token string">"检索首字母必须是一个字母"</span><span class="token punctuation">,</span>groups<span class="token operator">=</span><span class="token punctuation">{</span>AddGroup<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>UpdateGroup<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> String firstLetter<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/**
     * 排序
     */</span>
    <span class="token annotation punctuation">@NotNull</span><span class="token punctuation">(</span>groups<span class="token operator">=</span><span class="token punctuation">{</span>AddGroup<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Min</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>message<span class="token operator">=</span><span class="token string">"排序必须大于等于0"</span><span class="token punctuation">,</span>groups<span class="token operator">=</span><span class="token punctuation">{</span>AddGroup<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>UpdateGroup<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> Integer sort<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre>
</li>
<li><p>controller指定接口什么情况校验，add都时候：<code>@Validated(AddGroup.class)</code>，update都时候：<code>@Validated(UpdateGroup.class)</code></p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** 添加*/</span>
<span class="token keyword">public</span> R <span class="token function">save</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Validated</span><span class="token punctuation">(</span>AddGroup<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token annotation punctuation">@RequestBody</span> BrandEntity brand<span class="token comment" spellcheck="true">/*, BindingResult result*/</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   brandService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>brand<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> R<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">/** 修改 */</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/update"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> R <span class="token function">update</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Validated</span><span class="token punctuation">(</span>UpdateGroup<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token annotation punctuation">@RequestBody</span> BrandEntity brand<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   brandService<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>brand<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> R<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</li>
</ol>
<h2><span id="自定义校验">自定义校验</span></h2><ol>
<li><p>编写一个自定义的注解</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>lpc<span class="token punctuation">.</span>common<span class="token punctuation">.</span>valid<span class="token punctuation">;</span>

<span class="token keyword">import</span> javax<span class="token punctuation">.</span>validation<span class="token punctuation">.</span>Constraint<span class="token punctuation">;</span>
<span class="token keyword">import</span> javax<span class="token punctuation">.</span>validation<span class="token punctuation">.</span>Payload<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>*<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 *@author: lpc
 *@date: 10/12/2021 下午 2:30
 *@describe:
 *@vision
 */</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Constraint</span><span class="token punctuation">(</span>
        <span class="token comment" spellcheck="true">//绑定自定义校验器,可以添加多个校验器，适应不同d</span>
        validatedBy <span class="token operator">=</span> <span class="token punctuation">{</span>ListValueConstrainValidator<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">{</span>ElementType<span class="token punctuation">.</span>METHOD<span class="token punctuation">,</span> ElementType<span class="token punctuation">.</span>FIELD<span class="token punctuation">,</span> ElementType<span class="token punctuation">.</span>ANNOTATION_TYPE<span class="token punctuation">,</span> ElementType<span class="token punctuation">.</span>CONSTRUCTOR<span class="token punctuation">,</span> ElementType<span class="token punctuation">.</span>PARAMETER<span class="token punctuation">,</span> ElementType<span class="token punctuation">.</span>TYPE_USE<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span>RetentionPolicy<span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span>
<span class="token keyword">public</span> @<span class="token keyword">interface</span> <span class="token class-name">ListValue</span> <span class="token punctuation">{</span>
   <span class="token comment" spellcheck="true">//默认提示</span>
    String <span class="token function">message</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">"{com.lpc.common.valid.ListValue.message}"</span><span class="token punctuation">;</span>

    Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">groups</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    Class<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Payload</span><span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">payload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">vals</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>新建<code>ValidationMessages.properties</code>作为默认messages提示</p>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">com.lpc.common.valid.ListValue.message</span><span class="token punctuation">=</span><span class="token attr-value">必须提交指定都值</span>
</code></pre>
</li>
<li><p>编写一个自定义都校验器</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>lpc<span class="token punctuation">.</span>common<span class="token punctuation">.</span>valid<span class="token punctuation">;</span>

<span class="token keyword">import</span> javax<span class="token punctuation">.</span>validation<span class="token punctuation">.</span>ConstraintValidator<span class="token punctuation">;</span>
<span class="token keyword">import</span> javax<span class="token punctuation">.</span>validation<span class="token punctuation">.</span>ConstraintValidatorContext<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>HashSet<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Set<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * @author: lpc
 * @date: 10/12/2021 下午 2:37
 * @describe:
 * @vision
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ListValueConstrainValidator</span> <span class="token keyword">implements</span> <span class="token class-name">ConstraintValidator</span><span class="token operator">&lt;</span>ListValue<span class="token punctuation">,</span> Integer<span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> Set<span class="token operator">&lt;</span>Integer<span class="token operator">></span> set <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">// 初始化方法</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initialize</span><span class="token punctuation">(</span>ListValue constraintAnnotation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> vals <span class="token operator">=</span> constraintAnnotation<span class="token punctuation">.</span><span class="token function">vals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> val <span class="token operator">:</span> vals<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      set<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment" spellcheck="true">// 判断是否校验成功</span>

  <span class="token comment" spellcheck="true">/**
   *
   * @param value 需要校验的值
   * @param context
   * @return
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isValid</span><span class="token punctuation">(</span>Integer value<span class="token punctuation">,</span> ConstraintValidatorContext context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> set<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</li>
<li><p>关联自定义的校验器和自定义的校验注解</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@ListValue</span><span class="token punctuation">(</span>vals<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>groups<span class="token operator">=</span><span class="token punctuation">{</span>AddGroup<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> Integer showStatus<span class="token punctuation">;</span>
</code></pre>
</li>
</ol>
<h1><span id="时间格式化">时间格式化</span></h1><p>配置文件加入配置，格式化项目里全部的日期</p>
<p>阿里jsckson的</p>
<pre class=" language-yml"><code class="language-yml">spring:
  jackson:
    date-format: yyyy-MM-dd HH:mm:ss
</code></pre>
<p>springmvc的</p>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">spring.mvc.date-format</span><span class="token punctuation">=</span><span class="token attr-value">yyyy-MM-dd HH:mm:ss</span>
</code></pre>
<h1><span id="es">ES</span></h1><ul>
<li>1、导入依赖</li>
<li>2、编写配置 :给容器里注入RestHighLevelClient</li>
<li>3、参照官方文档操作api</li>
</ul>
<pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#匹配全部 排序 分页 筛选只显示两个字段</span>
GET bank/_search
<span class="token punctuation">{</span>
  <span class="token string">"query"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
    <span class="token string">"match_all"</span><span class="token keyword">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
  <span class="token string">"sort"</span><span class="token keyword">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">"balance"</span><span class="token keyword">:</span> <span class="token string">"desc"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>,
  <span class="token string">"from"</span><span class="token keyword">:</span> 5,
  <span class="token string">"size"</span><span class="token keyword">:</span> 5,
  <span class="token string">"_source"</span>:<span class="token punctuation">[</span><span class="token string">"balance"</span>,<span class="token string">"firstname"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">#分词匹配 没有双引号绝对匹配</span>
GET bank/_search
<span class="token punctuation">{</span>
  <span class="token string">"query"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
    <span class="token string">"match"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
      <span class="token string">"account_number"</span><span class="token keyword">:</span> 20
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">#分词匹配</span>
GET bank/_search
<span class="token punctuation">{</span>
  <span class="token string">"query"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
    <span class="token string">"match"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
      <span class="token string">"address"</span><span class="token keyword">:</span> <span class="token string">"mill lane"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">#不分词匹配</span>
GET bank/_search
<span class="token punctuation">{</span>
  <span class="token string">"query"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
    <span class="token string">"match_phrase"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
      <span class="token string">"address"</span><span class="token keyword">:</span> <span class="token string">"mill lane"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment" spellcheck="true">#多字段匹配 会分词</span>
GET bank/_search
<span class="token punctuation">{</span>
  <span class="token string">"query"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
    <span class="token string">"multi_match"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
      <span class="token string">"query"</span><span class="token keyword">:</span> <span class="token string">"mill"</span>,
      <span class="token string">"fields"</span><span class="token keyword">:</span> <span class="token punctuation">[</span><span class="token string">"address"</span>,<span class="token string">"city"</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">#条件查询</span>
<span class="token comment" spellcheck="true">#must必须</span>
<span class="token comment" spellcheck="true">#must_not必须不满足</span>
<span class="token comment" spellcheck="true">#should满足不满足都行，满足得分高</span>
GET bank/_search
<span class="token punctuation">{</span>
  <span class="token string">"query"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
    <span class="token string">"bool"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
      <span class="token string">"must"</span><span class="token keyword">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token string">"match"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
            <span class="token string">"gender"</span><span class="token keyword">:</span> <span class="token string">"M"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>,
                <span class="token punctuation">{</span>
          <span class="token string">"match"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
            <span class="token string">"address"</span><span class="token keyword">:</span> <span class="token string">"mill"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>,
      <span class="token string">"must_not"</span><span class="token keyword">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token string">"match"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
            <span class="token string">"age"</span><span class="token keyword">:</span> <span class="token string">"18"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>,
      <span class="token string">"should"</span><span class="token keyword">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span><span class="token string">"match"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
          <span class="token string">"lastname"</span><span class="token keyword">:</span> <span class="token string">"Wallace"</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">#filter不计算得分 结果过滤</span>
<span class="token comment" spellcheck="true">#ranger区间</span>
GET bank/_search
<span class="token punctuation">{</span>
  <span class="token string">"query"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
    <span class="token string">"bool"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
      <span class="token string">"must"</span><span class="token keyword">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token string">"range"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
            <span class="token string">"age"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
              <span class="token string">"gte"</span><span class="token keyword">:</span> 18,
              <span class="token string">"lte"</span><span class="token keyword">:</span> 30
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

GET bank/_search
<span class="token punctuation">{</span>
  <span class="token string">"query"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
    <span class="token string">"bool"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
      <span class="token string">"filter"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
        <span class="token string">"range"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
          <span class="token string">"age"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
            <span class="token string">"gte"</span><span class="token keyword">:</span> 18,
            <span class="token string">"lte"</span><span class="token keyword">:</span> 30
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">#term精确查询 123这种适合</span>
GET bank/_search
<span class="token punctuation">{</span>
  <span class="token string">"query"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
    <span class="token string">"term"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
      <span class="token string">"age"</span><span class="token keyword">:</span> <span class="token string">"28"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">#规定：</span>
<span class="token comment" spellcheck="true">#term 没有引号</span>
<span class="token comment" spellcheck="true">#macth 文本</span>
</code></pre>
<h2><span id="aggs">Aggs</span></h2><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#搜索address中包含mill的所有人的年龄分布以及平均年龄和薪资</span>
<span class="token comment" spellcheck="true">#聚合aggs：</span>
<span class="token comment" spellcheck="true">#聚合age的所有情况(比如：38的有几位，28的有几位)</span>
<span class="token comment" spellcheck="true">#聚合类型:terms、avg</span>
<span class="token comment" spellcheck="true">#size大小：如果有100中情况，只展示10个</span>
GET bank/_search
<span class="token punctuation">{</span>
  <span class="token string">"query"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
    <span class="token string">"match"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
      <span class="token string">"address"</span><span class="token keyword">:</span> <span class="token string">"mill"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
  <span class="token string">"aggs"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
    <span class="token string">"ageAgg"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
      <span class="token string">"terms"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
        <span class="token string">"field"</span><span class="token keyword">:</span> <span class="token string">"age"</span>,
        <span class="token string">"size"</span><span class="token keyword">:</span> 10
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>,
    <span class="token string">"ageAvg"</span>:<span class="token punctuation">{</span>
       <span class="token string">"avg"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
         <span class="token string">"field"</span><span class="token keyword">:</span> <span class="token string">"age"</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>,
    <span class="token string">"balanceAvg"</span>:<span class="token punctuation">{</span>
      <span class="token string">"avg"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
        <span class="token string">"field"</span><span class="token keyword">:</span> <span class="token string">"balance"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
  <span class="token string">"size"</span><span class="token keyword">:</span> 0
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#按照年龄聚合，并且请求这些年龄段的这些人的平均薪资</span>
<span class="token comment" spellcheck="true">#子聚合</span>
GET bank/_search
<span class="token punctuation">{</span>
  <span class="token string">"query"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
    <span class="token string">"match_all"</span><span class="token keyword">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
  <span class="token string">"aggs"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
    <span class="token string">"ageAgg"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
      <span class="token string">"terms"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
        <span class="token string">"field"</span><span class="token keyword">:</span> <span class="token string">"age"</span>,
        <span class="token string">"size"</span><span class="token keyword">:</span> 100
      <span class="token punctuation">}</span>,
      <span class="token string">"aggs"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
        <span class="token string">"balanceAvg"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
          <span class="token string">"avg"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
            <span class="token string">"field"</span><span class="token keyword">:</span> <span class="token string">"balance"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#查出所有年龄分布，并且这些年龄段中M的平均薪资和F的平均薪资以及这个年龄段的总体平均薪资</span>
GET bank/_search
<span class="token punctuation">{</span>
  <span class="token string">"query"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
    <span class="token string">"match_all"</span><span class="token keyword">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
  <span class="token string">"aggs"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
    <span class="token string">"ageAgg"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
      <span class="token string">"terms"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
        <span class="token string">"field"</span><span class="token keyword">:</span> <span class="token string">"age"</span>,
        <span class="token string">"size"</span><span class="token keyword">:</span> 100
      <span class="token punctuation">}</span>,
      <span class="token string">"aggs"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
        <span class="token string">"genderAgg"</span>:<span class="token punctuation">{</span>
          <span class="token string">"terms"</span>:<span class="token punctuation">{</span>
             <span class="token string">"field"</span><span class="token keyword">:</span> <span class="token string">"gender.keyword"</span>
          <span class="token punctuation">}</span>,
          <span class="token string">"aggs"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
            <span class="token string">"balanceAvg"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
              <span class="token string">"avg"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
                <span class="token string">"field"</span><span class="token keyword">:</span> <span class="token string">"balance"</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2><span id="mapping">Mapping</span></h2><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#查看映射</span>
GET /bank/_mapping

<span class="token comment" spellcheck="true">#创建索引并指定映射</span>
PUT /my_index
<span class="token punctuation">{</span>
  <span class="token string">"mappings"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
    <span class="token string">"properties"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
      <span class="token string">"age"</span>:<span class="token punctuation">{</span><span class="token string">"type"</span><span class="token keyword">:</span> <span class="token string">"integer"</span><span class="token punctuation">}</span>,
      <span class="token string">"email"</span>:<span class="token punctuation">{</span><span class="token string">"type"</span><span class="token keyword">:</span> <span class="token string">"keyword"</span><span class="token punctuation">}</span>,
      <span class="token string">"name"</span>:<span class="token punctuation">{</span><span class="token string">"type"</span><span class="token keyword">:</span> <span class="token string">"text"</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#添加映射字段</span>
<span class="token comment" spellcheck="true">#index:false 禁止索引(默认true)，以后都不能被检索到：用于冗余字段</span>
PUT /my_index/_mapping
<span class="token punctuation">{</span>
  <span class="token string">"properties"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
    <span class="token string">"employee-id"</span>:<span class="token punctuation">{</span>
      <span class="token string">"type"</span><span class="token keyword">:</span><span class="token string">"keyword"</span>,
      <span class="token string">"index"</span>:false
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">#修改映射字段：改不了，可以数据迁移(创建新的映射)</span>
</code></pre>
<pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#数据迁移</span>

<span class="token comment" spellcheck="true">#新建一个映射</span>
PUT /newbank
<span class="token punctuation">{</span>
  <span class="token string">"mappings"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
    <span class="token string">"properties"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
      <span class="token string">"account_number"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
        <span class="token string">"type"</span><span class="token keyword">:</span> <span class="token string">"long"</span>
      <span class="token punctuation">}</span>,
      <span class="token string">"address"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
        <span class="token string">"type"</span><span class="token keyword">:</span> <span class="token string">"text"</span>
      <span class="token punctuation">}</span>,
      <span class="token string">"age"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
        <span class="token string">"type"</span><span class="token keyword">:</span> <span class="token string">"integer"</span>
      <span class="token punctuation">}</span>,
      <span class="token string">"balance"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
        <span class="token string">"type"</span><span class="token keyword">:</span> <span class="token string">"long"</span>
      <span class="token punctuation">}</span>,
      <span class="token string">"city"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
        <span class="token string">"type"</span><span class="token keyword">:</span> <span class="token string">"keyword"</span>
      <span class="token punctuation">}</span>,
      <span class="token string">"email"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
        <span class="token string">"type"</span><span class="token keyword">:</span> <span class="token string">"keyword"</span>
      <span class="token punctuation">}</span>,
      <span class="token string">"employer"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
        <span class="token string">"type"</span><span class="token keyword">:</span> <span class="token string">"keyword"</span>
      <span class="token punctuation">}</span>,
      <span class="token string">"firstname"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
        <span class="token string">"type"</span><span class="token keyword">:</span> <span class="token string">"text"</span>
      <span class="token punctuation">}</span>,
      <span class="token string">"gender"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
        <span class="token string">"type"</span><span class="token keyword">:</span> <span class="token string">"text"</span>
      <span class="token punctuation">}</span>,
      <span class="token string">"lastname"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
        <span class="token string">"type"</span><span class="token keyword">:</span> <span class="token string">"text"</span>,
        <span class="token string">"fields"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
          <span class="token string">"keyword"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
            <span class="token string">"type"</span><span class="token keyword">:</span> <span class="token string">"keyword"</span>,
            <span class="token string">"ignore_above"</span><span class="token keyword">:</span> 256
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>,
      <span class="token string">"state"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
        <span class="token string">"type"</span><span class="token keyword">:</span> <span class="token string">"text"</span>,
        <span class="token string">"fields"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
          <span class="token string">"keyword"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
            <span class="token string">"type"</span><span class="token keyword">:</span> <span class="token string">"keyword"</span>,
            <span class="token string">"ignore_above"</span><span class="token keyword">:</span> 256
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
GET /bank/_search

<span class="token comment" spellcheck="true">#数据迁移</span>
<span class="token comment" spellcheck="true">#type有了写，没有不写，6版本以后渐渐没有type</span>
POST _reindex
<span class="token punctuation">{</span>
  <span class="token string">"source"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
    <span class="token string">"index"</span><span class="token keyword">:</span> <span class="token string">"bank"</span>,
    <span class="token string">"type"</span><span class="token keyword">:</span> <span class="token string">"account"</span>
  <span class="token punctuation">}</span>,
  <span class="token string">"dest"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
    <span class="token string">"index"</span><span class="token keyword">:</span> <span class="token string">"newbank"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
GET /newbank/_search
</code></pre>
<h2><span id="分词">分词</span></h2><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#分词</span>
<span class="token comment" spellcheck="true">#standard默认分词器 对英文分词的 需要安装中文分词器</span>
POST _analyze
<span class="token punctuation">{</span>
  <span class="token string">"analyzer"</span><span class="token keyword">:</span> <span class="token string">"standard"</span>,
  <span class="token string">"text"</span><span class="token keyword">:</span><span class="token string">"我是中国人"</span>
<span class="token punctuation">}</span>
</code></pre>
<p>安装中文分词器,再次运行，发现<code>中国人</code>分成了一个词</p>
<p>ik_smart:最佳分词</p>
<p>ik_max_word:最多分词</p>
<pre class=" language-bash"><code class="language-bash">POST _analyze
<span class="token punctuation">{</span>
  <span class="token string">"analyzer"</span><span class="token keyword">:</span> <span class="token string">"ik_smart"</span>,
  <span class="token string">"text"</span><span class="token keyword">:</span><span class="token string">"我是中国人"</span>
<span class="token punctuation">}</span>
</code></pre>
<h1><span id="整合redis">整合Redis</span></h1><ol>
<li>引入data-redis-starter</li>
<li>简单配置redis的host等信息</li>
<li>使用springboot自动配置好的redisTemplate来操作redis</li>
</ol>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20211218124613864.png" alt="image-20211218124613864"></p>
<p>1、缓存空结果：解决缓存穿透 </p>
<p>2、设置过期时间(加随机值):解决缓存雪崩 </p>
<p>3、加锁：解决缓存击穿</p>
<h1><span id="redisson">Redisson</span></h1><ol>
<li>引入依赖</li>
<li>配置redisson</li>
</ol>
<blockquote>
<p>解决的问题：</p>
</blockquote>
<ul>
<li>锁的自动续期：不会因为业务时间长，锁会过期；(默认存活时期是30秒，不够会续期)</li>
<li>没有死锁问题：加锁业务只要运行完成就不会续期，即使没有手动解锁，默认30秒以后自动解锁</li>
<li>加锁时会阻塞：等待业务没有锁的时候才去上锁</li>
</ul>
<blockquote>
<p>注意：手动指定过期时间没有看门狗续期</p>
</blockquote>
<p>原因：</p>
<ul>
<li>如果指定了超时时间，就会发送redis执行脚本，进行占锁，默认就是我们的超时时间</li>
<li>没有指定超时时间，就使用30*1000【LockWatchdogTimeout看门狗的默认时间】，只要占锁成功，就会启动一个定时任务【重新给锁设置过期时间，新的过期时间就是看门狗的默认时间】【续期时间：看门狗时间的1/3，就续满30时间】</li>
</ul>
<p>最佳实战：</p>
<ul>
<li>推荐指定超时时间(省掉了续期操作)，指定一个长时间就行，然后手动解锁</li>
</ul>
<blockquote>
<p>读写锁：</p>
</blockquote>
<ul>
<li>写锁没释放的时候，读锁会等待写锁释放才能获取。<ul>
<li>写+读：等待写锁释放</li>
<li>写+写：排队，阻塞方式</li>
<li>读+写：等待读锁释放</li>
<li>读+读：无序和没锁一样，并发时都能获取到读锁</li>
<li>==总结：只要有写，都必须等待==</li>
</ul>
</li>
<li>读锁：共享锁</li>
<li>写锁：排他锁/互斥锁/独享锁</li>
</ul>
<blockquote>
<p>信号量</p>
</blockquote>
<p>有3个停车位</p>
<p>停一辆车就-1个停车位</p>
<p>停车位=0时</p>
<p>就停不了车了</p>
<p>==停车位：信号量==</p>
<p>限流</p>
<blockquote>
<p>闭锁</p>
</blockquote>
<p>放假，锁门</p>
<p>5个班</p>
<p>所有班走完</p>
<p>才能锁门</p>
<p>==减法计数器：5变成0时才释放锁==</p>
<blockquote>
<p>缓存里的数据如何跟数据库保持一致</p>
</blockquote>
<p>缓存数据一致性问题?</p>
<p>1、双写模式（改数据库，改缓存）</p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20211218203305118.png" alt="image-20211218203305118"></p>
<p>有问题：</p>
<p>两次请求都采用双写模式来修改数据，</p>
<p>一个去改数据库，然后改缓存，</p>
<p>另一个也去改数据库，改缓存，</p>
<p>第二个比第一个改缓存改的快，</p>
<p>最后第一个把第二个的缓存也改了，</p>
<p>最终数据库存的是第二修改的数据，但缓存的是第一个存的数据。</p>
<ul>
<li>加锁</li>
<li>暂时数据不一致，等缓存数据过期，之后放入最新数据</li>
</ul>
<p>2、失效模式（改数据库，删缓存）</p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20211218203324229.png" alt="image-20211218203324229"></p>
<p>又没有把最新的数据更新到缓存</p>
<ul>
<li>加锁</li>
</ul>
<blockquote>
<p>数据一致性–解决方案</p>
</blockquote>
<p>所有数据都带过期时间</p>
<p>读数据的时候加入，分布式读写锁</p>
<p>Canal</p>
<h1><span id="整合spring-cache-简化缓存开发">整合spring cache 简化缓存开发</span></h1><ol>
<li><p>引入依赖</p>
</li>
<li><p>编写配置</p>
<ol>
<li><p>自动配置了</p>
<ul>
<li>CacheAutoConfiguration会导入RedisCacheConfiguration</li>
<li>自动配好了缓存管理器RedisCacheManager</li>
</ul>
</li>
<li><p>自己配置</p>
<ul>
<li><p>配置redis作为缓存在配置文件中</p>
</li>
<li><pre class=" language-properties"><code class="language-properties"><span class="token attr-name">spring.cache.type</span><span class="token punctuation">=</span><span class="token attr-value">redis</span>
</code></pre>
</li>
</ul>
</li>
<li><p>测试使用缓存</p>
<pre class=" language-tex"><code class="language-tex">@Cacheable:触发将数据保存到缓存的操作
@CacheEvict:触发将数据从缓存删除的操作   失效模式
@CachePut:不影响方法执行更新缓存   双写模式
@Caching:组合以上操作
@CacheConfig:在类级别共享缓存的相同配置
</code></pre>
<ol>
<li><p>开启缓存功能在启动类上</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@EnableCaching</span>
</code></pre>
</li>
<li><p>只需要使用注解就能完成缓存操作了</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//每一个需要缓存的数据我们都来指定要放到那个名字的缓存【缓存分区(按照业务类型划分)】</span>
<span class="token annotation punctuation">@Cacheable</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"catagory"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//代表当前方法的结果需要缓存。如果缓存中有，方法不用调用。如果缓存中没有，则执行方法返回结果，顺便把结果放入缓存。</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> List<span class="token operator">&lt;</span>CategoryEntity<span class="token operator">></span> <span class="token function">getLevel1Categorys</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
</li>
<li><p>默认行为</p>
<ul>
<li>如果方法中有，方法不用调用</li>
<li>key默认自动生成<code>缓存的名字::SimpleKey []</code></li>
<li>缓存的value的值，默认使用jdk序列化后的数据作为value</li>
<li>默认过期时间，是-1，永不过期(需要自定义)</li>
</ul>
</li>
<li><p>自定义</p>
<ul>
<li><p>指定生成key，字符串记得加’’单引号</p>
<p><code>key属性，接收一个SpEl</code></p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Cacheable</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"catagory"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>key <span class="token operator">=</span> <span class="token string">"'level1Categorys'"</span><span class="token punctuation">)</span>
</code></pre>
<pre class=" language-java"><code class="language-java">key <span class="token operator">=</span> <span class="token string">"#root.method.name"</span>#使用方法名作为key，具体语法，百度
</code></pre>
</li>
<li><p>自定义缓存存活时间</p>
<p>配置文件写入</p>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">spring.cache.redis.time-to-live</span><span class="token punctuation">=</span><span class="token attr-value">3600000#单位毫秒 1小时</span>
</code></pre>
</li>
<li><p>value保存为json格式</p>
<p>添加自己的配置</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>lpc<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>product<span class="token punctuation">.</span>config<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>cache<span class="token punctuation">.</span>CacheProperties<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cache<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>EnableCaching<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Bean<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Configuration<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>cache<span class="token punctuation">.</span>RedisCacheConfiguration<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span>GenericJackson2JsonRedisSerializer<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span>RedisSerializationContext<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span>StringRedisSerializer<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * @author: lpc
 * @date: 19/12/2021 下午 12:37
 * @describe:
 * @vision
 */</span>
<span class="token annotation punctuation">@EnableCaching</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyCacheConfig</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">/**
   * 配置文件的设置没有用上，将配置文件的配置也设置进来
   * @return
   */</span>
  <span class="token annotation punctuation">@Bean</span>
  RedisCacheConfiguration <span class="token function">redisCacheConfiguration</span><span class="token punctuation">(</span>CacheProperties cacheProperties<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    RedisCacheConfiguration config <span class="token operator">=</span> RedisCacheConfiguration<span class="token punctuation">.</span><span class="token function">defaultCacheConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    config <span class="token operator">=</span>config<span class="token punctuation">.</span><span class="token function">serializeKeysWith</span><span class="token punctuation">(</span>RedisSerializationContext<span class="token punctuation">.</span>SerializationPair<span class="token punctuation">.</span><span class="token function">fromSerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    config <span class="token operator">=</span>config<span class="token punctuation">.</span><span class="token function">serializeValuesWith</span><span class="token punctuation">(</span>RedisSerializationContext<span class="token punctuation">.</span>SerializationPair<span class="token punctuation">.</span><span class="token function">fromSerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GenericJackson2JsonRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    CacheProperties<span class="token punctuation">.</span>Redis redisProperties <span class="token operator">=</span> cacheProperties<span class="token punctuation">.</span><span class="token function">getRedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//将配置文件中所有的配置都生效</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getTimeToLive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">entryTtl</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getTimeToLive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getKeyPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">prefixKeysWith</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getKeyPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>redisProperties<span class="token punctuation">.</span><span class="token function">isCacheNullValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">disableCachingNullValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>redisProperties<span class="token punctuation">.</span><span class="token function">isUseKeyPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">disableKeyPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> config<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</li>
</ul>
</li>
</ol>
</li>
<li><p>原理</p>
<p>CacheAutoConfiguration  –&gt;   RedisCacheConfiguration  –&gt;  </p>
<p>自动配置了RedisCacheManager –&gt;  初始化所有的缓存   –&gt;  每个缓存决定使用什么配置</p>
<p>–&gt;  使用默认配置(如果没有自定义配置)   –&gt;  想修改缓存配置，只需在容器中放一个 RedisCacheConfiguration即可 –&gt;他会自动应用到RedisCacheManager 管理的所有缓存分区中</p>
</li>
<li><p>其他配置</p>
<pre class=" language-properties"><code class="language-properties"><span class="token comment" spellcheck="true">#key前缀,没有默认使用缓存名字作为前缀 建议不指定，用默认分区作为前缀</span>
<span class="token attr-name">spring.cache.redis.key-prefix</span><span class="token punctuation">=</span><span class="token attr-value">CACHE_ </span>
<span class="token comment" spellcheck="true">#是否使用前缀，默认true开启</span>
<span class="token attr-name">spring.cache.redis.use-key-prefix</span><span class="token punctuation">=</span><span class="token attr-value">true</span>
<span class="token comment" spellcheck="true">#是否缓存空值</span>
<span class="token attr-name">spring.cache.redis.cache-null-values</span><span class="token punctuation">=</span><span class="token attr-value">true</span>
</code></pre>
</li>
<li><p>Spring-Cache的不足</p>
<ol>
<li><p>读模式</p>
<ul>
<li><p>缓存穿透 ：查询一个null数据。解决：缓存空数据。</p>
<p> Spring-Cache提供了</p>
<pre class=" language-properties"><code class="language-properties"><span class="token comment" spellcheck="true">#是否缓存空值</span>
<span class="token attr-name">spring.cache.redis.cache-null-values</span><span class="token punctuation">=</span><span class="token attr-value">true</span>
</code></pre>
</li>
<li><p>缓存击穿：大量请求同时查询一个正好过期的数据。解决：加锁</p>
<p>Spring-Cache提供，没有分布式锁，可以设置同步锁解决击穿</p>
<p>只有 @Cacheable有sync属性</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Cacheable</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"catagory"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>key <span class="token operator">=</span> <span class="token string">"#root.method.name"</span><span class="token punctuation">,</span>sync <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
</code></pre>
</li>
<li><p>缓存雪崩：当量缓存同时过期。解决：加过期时间</p>
<p>提供</p>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">spring.cache.redis.time-to-live</span><span class="token punctuation">=</span><span class="token attr-value">3600000</span>
</code></pre>
</li>
</ul>
</li>
<li><p>写模式：(缓存与数据库一致)</p>
<ul>
<li>读写加锁</li>
<li>进入Canal，感知mysql更新自动更新缓存</li>
<li>读多写多，直接去数据查询</li>
</ul>
</li>
<li><p>总结：</p>
<ul>
<li>常规数据(读多写少，及时性，一致性要求不高的；)，完全可以使用SpringCache</li>
<li>特殊数据：需要特殊设计</li>
</ul>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<h1><span id="创建线程的四种方式">创建线程的四种方式</span></h1><p><img src="/2022/01/10/gulimall-bi-ji/image-20211222120545683.png" alt="image-20211222120545683"></p>
<p>推荐使用第四种</p>
<h2><span id="运行流程">运行流程：</span></h2><p>1、线程池创建，准备好 core 数量的核心线程，准备接受任务 </p>
<p>2、新的任务进来，用 core 准备好的空闲线程执行。 </p>
<ul>
<li><p>(1) 、core 满了，就将再进来的任务放入阻塞队列中。空闲的 core 就会自己去阻塞队 </p>
<p>列获取任务执行 </p>
<p>(2) 、阻塞队列满了，就直接开新线程执行，最大只能开到 max 指定的数量 </p>
<p>(3) 、max 都执行好了。Max-core 数量空闲的线程会在 keepAliveTime 指定的时间后自 </p>
<p>动销毁。最终保持到 core 大小 </p>
<p>(4) 、如果线程数开到了 max 的数量，还有新任务进来，就会使用 reject 指定的拒绝策 </p>
<p>略进行处理 </p>
</li>
</ul>
<p>3、所有的线程创建都是由指定的 factory 创建的。</p>
<h1><span id="重定向传值">重定向传值</span></h1><p>使用<code>RedirectAttributes redirectAttributes</code></p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//下一个页面只要取了这个数据，session里就会删掉,利用session，需要解决session共享问题</span>
redirectAttributes<span class="token punctuation">.</span><span class="token function">addFlashAttribute</span><span class="token punctuation">(</span><span class="token string">"errors"</span><span class="token punctuation">,</span> errors<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//重定向携带数据，放在?后边</span>
redirectAttributes<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">"skuId"</span><span class="token punctuation">,</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>代替Model model</p>
<p>原理:使用了session(分布式需要解决共享问题)</p>
<h1><span id="gitee授权登录">Gitee授权登录</span></h1><p><a target="_blank" rel="noopener" href="https://gitee.com/api/v5/oauth_doc#/">https://gitee.com/api/v5/oauth_doc#/</a></p>
<h1><span id="session共享问题">Session共享问题</span></h1><p>解决方案：</p>
<ol>
<li><p>session复制(不推荐)</p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20211227101822692.png" alt="image-20211227101822692"></p>
</li>
<li><p>客户端存储(不推荐)</p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20211227102158141.png" alt="image-20211227102158141"></p>
</li>
<li><p>利用hash一致性</p>
<ul>
<li>你的session存储到a服务器，那你以后的请求都落到a服务器处理</li>
</ul>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20211227102255532.png" alt="image-20211227102255532"></p>
</li>
<li><p>统一存储</p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20211227103916077.png" alt="image-20211227103916077"></p>
</li>
<li><p>子域共享</p>
<ul>
<li>继承了父亲的session</li>
</ul>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20211227104616271.png" alt="image-20211227104616271"></p>
<p>子域怎么方父域？</p>
<ul>
<li><p>加入配置类</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Bean<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Configuration<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>session<span class="token punctuation">.</span>web<span class="token punctuation">.</span>http<span class="token punctuation">.</span>CookieSerializer<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>session<span class="token punctuation">.</span>web<span class="token punctuation">.</span>http<span class="token punctuation">.</span>DefaultCookieSerializer<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 *@author: lpc
 *@date: 27/12/2021 下午 12:23
 *@describe:
 *@vision
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GulimallSessionConfig</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Bean</span>
  <span class="token keyword">public</span> CookieSerializer <span class="token function">cookieSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      DefaultCookieSerializer cookieSerializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultCookieSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token comment" spellcheck="true">//指定作用域</span>
      cookieSerializer<span class="token punctuation">.</span><span class="token function">setDomainName</span><span class="token punctuation">(</span><span class="token string">"gulimall.com"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      cookieSerializer<span class="token punctuation">.</span><span class="token function">setCookieName</span><span class="token punctuation">(</span><span class="token string">"GULISESSION"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> cookieSerializer<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</li>
</ul>
</li>
</ol>
<h2><span id="json序列化存入redis">JSON序列化存入Redis</span></h2><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> RedisSerializer<span class="token operator">&lt;</span>Object<span class="token operator">></span> <span class="token function">springSessionDefaultRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">GenericJackson2JsonRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h1><span id="整合spring-session">整合Spring Session</span></h1><p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-session/reference/2.6.1/guides/boot-redis.html">https://docs.spring.io/spring-session/reference/2.6.1/guides/boot-redis.html</a></p>
<p>示例在gulimall-auth-server服务下</p>
<ol>
<li><p>添加依赖</p>
<pre class=" language-xml"><code class="language-xml"><span class="token comment" spellcheck="true">&lt;!--spring session--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.session<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-session-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
</code></pre>
</li>
<li><p>添加配置</p>
<pre class=" language-properties"><code class="language-properties"><span class="token comment" spellcheck="true">#指定session在session中</span>
<span class="token attr-name">spring.session.store-type</span><span class="token punctuation">=</span><span class="token attr-value">redis</span>
<span class="token attr-name">server.servlet.session.timeout</span><span class="token punctuation">=</span><span class="token attr-value">30m</span>
</code></pre>
</li>
<li><p>加入配置注解</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@EnableRedisHttpSession</span>
</code></pre>
</li>
</ol>
<h2><span id="核心原理">核心原理</span></h2><ol>
<li><p><code>@EnableRedisHttpSession</code>导入了<code>RedisHttpSessionConfiguration.class</code></p>
<ol>
<li><p>给容器中添加了一个组件:<code>RedisOperationsSessionRepository</code>:==redis操作session==</p>
</li>
<li><p>放了一个SessionRepositoryFilter:==session存储过滤器==,每个请求都要经过过滤器</p>
<ol>
<li><p>创建的时候，就自动从容器中获取到了SessionRepository【RedisOperationsSessionRepository】</p>
</li>
<li><p>核心原理</p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20211227155500104.png" alt="image-20211227155500104"></p>
<p>原生的request和response都被包装</p>
</li>
<li><p>以后我们获取session。request.getSession();</p>
</li>
<li><p>就等于WrappedRequest.getSession() ====&gt; SessionRepository中获取到</p>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<p>==装饰者模式==</p>
<p>自定延期：页面刷新，redis中的过期时间也刷新了【spriong session中也提供了这个功能】</p>
<h1><span id="单点登录">单点登录</span></h1><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_37126175/article/details/107750145">https://blog.csdn.net/qq_37126175/article/details/107750145</a></p>
<ol>
<li>客户端访问受保护的资源的时候<br> 1.1 判断session中是否有LoginUser<br> 1.2 判断请求路径中是否有访问令牌token<br> 1.3 如果上述都没有的情况，跳转到登录服务器SSOServer+redirectUrl地址（带上当前网址，为了后面登录后跳转）<pre class=" language-java"><code class="language-java"> <span class="token keyword">return</span> <span class="token string">"redirect:"</span><span class="token operator">+</span>ssoServer<span class="token operator">+</span><span class="token string">"?redirect_url=http://client2.com:8082/employees"</span><span class="token punctuation">;</span>
</code></pre>
</li>
<li>SsoServer登录服务器<br> 2.1 首先判断cookie中是否有登录记录，如果cookie中有记录取出cookie对应的token值，<pre><code> 带上访问令牌重定向到redirect_url=http://client2.com:8082/employees";
</code></pre>
 2.2 没有cookie则跳转到login.html登录页面输入登录信息<br> 2.3 登录页面发送表单post请求登录，验证登录信息成功后<pre><code> 2.3.1 传一个UUID作为key，value作为userID 将该键值对放入认证服务器的Cookie中在认证系统中记录登录标记   
</code></pre>
<pre class=" language-java"><code class="language-java"> Cookie sso_token <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cookie</span><span class="token punctuation">(</span><span class="token string">"sso_token"</span><span class="token punctuation">,</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
 ​    2.3.2 重定向到回调地址+访问令牌<pre class=" language-java"><code class="language-java"> <span class="token keyword">return</span> <span class="token string">"redirect:"</span><span class="token operator">+</span>url<span class="token operator">+</span><span class="token string">"?token="</span><span class="token operator">+</span>token<span class="token punctuation">;</span>        
</code></pre>
</li>
</ol>
<p>==关键：给认证服务器留下痕迹==</p>
<h1><span id="threadlocal">ThreadLocal</span></h1><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> ThreadLocal<span class="token operator">&lt;</span>UserInfoTo<span class="token operator">></span> threadLocal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token operator">&lt;</span>UserInfoTo<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>cart服务用到：</p>
<p>加入了拦截器，每一个请求过来先经过拦截器，然后放入一个ThreadLocal线程，里面放入一些数据</p>
<pre class=" language-java"><code class="language-java">UserInfoTo userInfoTo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserInfoTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
threadLocal<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>userInfoTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>之后这个请求是哪个处理器处理，就可以获取到这些数据，实现数据共享==(仅这条线程可以获取)==</p>
<pre class=" language-java"><code class="language-java">UserInfoTo userInfoTo <span class="token operator">=</span> CartInterceptor<span class="token punctuation">.</span>threadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h1><span id="消息中间件">消息中间件</span></h1><ol>
<li>大多应用中，可通过消息服务中间件来提升系统==异步通信、扩展解耦==能力 </li>
<li>消息服务中两个重要概念： 消息代理（message broker）和目的地（destination） 当消息发送者发送消息以后，将由消息代理接管，消息代理保证消息传递到指定目的地。 </li>
<li>消息队列主要有两种形式的目的地 <ol>
<li>队列（queue）：点对点消息通信（point-to-point）【4】</li>
<li> 主题（topic）：发布（publish）/订阅（subscribe）消息通信 【5】</li>
</ol>
</li>
<li>点对点式： <ul>
<li>消息发送者发送消息，消息代理将其放入一个队列中，消息接收者从队列中获取消息内容，消息读取后被移出队列</li>
<li>消息只有唯一的发送者和接受者，但并不是说只能有一个接收者</li>
</ul>
</li>
<li>发布订阅式：<ul>
<li>发送者（发布者）发送消息到主题，多个接收者（订阅者）监听（订阅）这个主题，那么就会在消息到达时同时收到消息</li>
</ul>
</li>
<li>JMS（Java Message Service）JAVA消息服务：<ul>
<li>基于JVM消息代理的规范。ActiveMQ、HornetMQ是JMS实现</li>
</ul>
</li>
<li>AMQP（Advanced Message Queuing Protocol）<ul>
<li>高级消息队列协议，也是一个消息代理的规范，兼容JMS</li>
<li>RabbitMQ是AMQP的实现</li>
</ul>
</li>
<li>Spring支持 <ul>
<li>spring-jms提供了对JMS的支持</li>
<li>spring-rabbit提供了对AMQP的支持</li>
<li>需要ConnectionFactory的实现来连接消息代理</li>
<li>提供JmsTemplate、RabbitTemplate来发送消息 </li>
<li>@JmsListener（JMS）、@RabbitListener（AMQP）注解在方法上监听消息<strong>代理发布的消息</strong></li>
<li>@EnableJms、@EnableRabbit开启支持</li>
</ul>
</li>
<li>Spring Boot自动配置 <ul>
<li><strong>JmsAutoConfiguration</strong> </li>
<li><strong>RabbitAutoConfiguration</strong></li>
</ul>
</li>
<li>市面的MQ产品<ul>
<li>ActiveMQ、RabbitMQ、RocketMQ、Kafka</li>
</ul>
</li>
</ol>
<h2><span id="jms与amqp">JMS与AMQP</span></h2><p><img src="/2022/01/10/gulimall-bi-ji/image-20211229193030127.png" alt="image-20211229193030127"></p>
<h2><span id="rabbitmq概念">RabbitMQ概念</span></h2><p><strong>RabbitMQ</strong>简介：</p>
<p>RabbitMQ是一个由erlang开发的AMQP(Advanved Message Queue Protocol)的开源实现。 </p>
<p><strong>核心概念</strong> </p>
<p><strong>Message</strong> </p>
<p>消息，消息是不具名的，它由消息头和消息体组成。消息体是不透明的，而消息头则由一系列的可选属性组成， </p>
<p>这些属性包括<strong>routing-key</strong>（路由键）、priority（相对于其他消息的优先权）、delivery-mode（指出该消息可 能需要持久性存储）等。 </p>
<p><strong>Publisher</strong> </p>
<p>消息的生产者，也是一个向交换器发布消息的客户端应用程序。 </p>
<p><strong>Exchange</strong> </p>
<p>交换器，用来接收生产者发送的消息并将这些消息路由给服务器中的队列。 </p>
<p>Exchange有4种类型：direct(默认)，fanout, topic, 和headers，不同类型的Exchange转发消息的策略有所区别</p>
<p><strong>Queue</strong> </p>
<p>消息队列，用来保存消息直到发送给消费者。它是消息的容器，也是消息的终点。一个消息可投入一个或多个队列。消息一直在队列里面，等待消费者连接到这个队列将其取走。 </p>
<p><strong>Binding</strong> </p>
<p>绑定，用于消息队列和交换器之间的关联。一个绑定就是基于路由键将交换器和消息队列连接起来的路由规则，所以可以将交 换器理解成一个由绑定构成的路由表。 Exchange 和Queue的绑定可以是多对多的关系。 </p>
<p><strong>Connection</strong> </p>
<p>网络连接，比如一个TCP连接。 </p>
<p><strong>Channel</strong> </p>
<p>信道，多路复用连接中的一条独立的双向数据流通道。信道是建立在真实的TCP连接内的虚拟连接，AMQP 命令都是通过信道 发出去的，不管是发布消息、订阅队列还是接收消息，这些动作都是通过信道完成。因为对于操作系统来说建立和销毁 TCP 都 是非常昂贵的开销，所以引入了信道的概念，以复用一条 TCP 连接。</p>
<p><strong>Consumer</strong> </p>
<p>消息的消费者，表示一个从消息队列中取得消息的客户端应用程序。 </p>
<p><strong>Virtual Host</strong> </p>
<p>虚拟主机，表示一批交换器、消息队列和相关对象。虚拟主机是共享相同的身份认证和加 </p>
<p>密环境的独立服务器域。每个 vhost 本质上就是一个 mini 版的 RabbitMQ 服务器，拥 </p>
<p>有自己的队列、交换器、绑定和权限机制。vhost 是 AMQP 概念的基础，必须在连接时 </p>
<p>指定，RabbitMQ 默认的 vhost 是 / 。 </p>
<p><strong>Broker</strong> </p>
<p>表示消息队列服务器实体</p>
<h2><span id="图解">图解*</span></h2><p><img src="/2022/01/10/gulimall-bi-ji/image-20211229203021998.png" alt="image-20211229203021998"></p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20211230102538414.png" alt="image-20211230102538414"></p>
<h2><span id="安装rabbitmq">安装RabbitMQ</span></h2><pre class=" language-bash"><code class="language-bash">docker run -d --name rabbitmq -p 5671:5671 -p 5672:5672 -p 4369:4369 -p 25672:25672 -p 15671:15671 -p 15672:15672 rabbitmq:management

docker update rabbitmq --restart<span class="token operator">=</span>always 
</code></pre>
<p>4369, 25672 (Erlang发现&amp;集群端口) </p>
<p>5672, 5671 (AMQP端口) </p>
<p>15672 (web管理后台端口) </p>
<p><a target="_blank" rel="noopener" href="http://192.168.67.217:15672/">http://192.168.67.217:15672/</a></p>
<p>账号：guest  密码：guest</p>
<p>61613, 61614 (STOMP协议端口) </p>
<p>1883, 8883 (MQTT协议端口) </p>
<p><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/networking.html">https://www.rabbitmq.com/networking.html</a></p>
<h2><span id="rabbitmq运行机制">RabbitMQ运行机制</span></h2><p>AMQP 中消息的路由过程和 Java 开发者熟悉的 JMS 存在一些差别， AMQP 中增加了 <strong>Exchange</strong> 和<strong>Binding</strong> 的角色。生产者把消息发布 到 Exchange 上，消息最终到达队列 并被消费者接收，而 Binding 决定交换器的消息应该发送到那个队列。</p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20211230102556932.png" alt="image-20211230102556932"></p>
<h2><span id="交换机类型">交换机类型</span></h2><p><strong>Exchange</strong>分发消息时根据类型的不同分发策略有区别，目前共四种类型：<strong>direct</strong>、 <strong>fanout</strong>、<strong>topic</strong>、<strong>headers</strong> 。headers 匹配 AMQP 消息的 header 而不是路由键， headers 交换器和 direct 交换器完全一致，但性能差很多，目前几乎用不到了，所以直接 看另外三种类型：</p>
<blockquote>
<p><strong>点对点</strong></p>
</blockquote>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20211230103737114.png" alt="image-20211230103737114"></p>
<blockquote>
<p><strong>广播</strong></p>
</blockquote>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20211230103746996.png" alt="image-20211230103746996"></p>
<blockquote>
<p><strong>主题</strong>(发布订阅)</p>
</blockquote>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20211230103942776.png" alt="image-20211230103942776"></p>
<h2><span id="测试">测试</span></h2><ol>
<li><p>创建交换机(学会创建，一会删除)</p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20211230104850416.png" alt="image-20211230104850416"></p>
</li>
<li><p>创建队列(一会测试需要)</p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20211230110459661.png" alt="image-20211230110459661"></p>
<p>再次创建多个队列</p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20211230111847002.png" alt="image-20211230111847002"></p>
</li>
<li><p>绑定队列(学会绑定)</p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20211230110826071.png" alt="image-20211230110826071"></p>
</li>
</ol>
<h3><span id="点对点">点对点</span></h3><ol>
<li><p>添加交换机</p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20211230112212685.png" alt="image-20211230112212685"></p>
</li>
<li><p>绑定队列(上边创建的四个)</p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20211230112438859.png" alt="image-20211230112438859"></p>
</li>
<li><p>发消息(在交换机下)</p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20211230112642515.png" alt="image-20211230112642515"></p>
<p>队列</p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20211230112708761.png" alt="image-20211230112708761"></p>
</li>
<li><p>获取消息</p>
<p>进入队列，获取消息(消息还在)</p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20211230112849235.png" alt="image-20211230112849235"></p>
<p>再次获取(队列中删除消息)</p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20211230113020273.png" alt="image-20211230113020273"></p>
<p>==关键：交换机(direct)发消息指定路由键==</p>
</li>
</ol>
<h3><span id="广播">广播</span></h3><ol>
<li><p>创建交换机</p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20211230114950610.png" alt="image-20211230114950610"></p>
</li>
<li><p>绑定队列</p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20211230115118335.png" alt="image-20211230115118335"></p>
</li>
<li><p>发消息</p>
</li>
<li><p>查看</p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20211230115935711.png" alt="image-20211230115935711"></p>
<p>与交换机绑定的队列全都接收到了消息</p>
<p>==关键：与交换机(fanout)绑定==</p>
</li>
</ol>
<h3><span id="主题">主题</span></h3><ol>
<li><p>创建交换机</p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20211230145410988.png" alt="image-20211230145410988"></p>
</li>
<li><p>添加队列(指定路由键)</p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20211230145645244.png" alt="image-20211230145645244"></p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20211230145656331.png" alt="image-20211230145656331"></p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20211230145707967-16408474292471.png" alt="image-20211230145707967"></p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20211230145714636.png" alt="image-20211230145714636"></p>
<p>总览</p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20211230145750146.png" alt="image-20211230145750146"></p>
</li>
<li><p>发消息</p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20211230150004276.png" alt="image-20211230150004276"></p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20211230150011732.png" alt="image-20211230150011732"></p>
<p>全部都接收到了消息(都匹配到了这个消息的路由键)</p>
<p>再次发送消息</p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20211230150158980.png" alt="image-20211230150158980"></p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20211230150148306.png" alt="image-20211230150148306"></p>
<p>只有lpc.news接受到了消息(.news匹配到了这个消息的路由键)</p>
<p>==关键：模糊匹配==</p>
</li>
</ol>
<h2><span id="rabbitmq消息确认机制-可靠抵达">RabbitMQ消息确认机制-可靠抵达</span></h2><p>保证消息不丢失，可靠抵达，可以使用事务消息，性能下降250倍，为此引入确认机制 </p>
<p>• <strong>publisher</strong> confirmCallback 确认模式 </p>
<p>• <strong>publisher</strong> returnCallback 未投递到 queue 退回模式 </p>
<p>• <strong>consumer</strong> ack机制 </p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20211230194121178.png" alt="image-20211230194121178"></p>
<blockquote>
<p>可靠抵达-ConfirmCallback</p>
</blockquote>
<p>==spring.rabbitmq.publisher-confirms=true==</p>
<ul>
<li>在创建 connectionFactory 的时候设置 PublisherConfirms(true) 选项，开启 confirmcallback。 </li>
<li>CorrelationData：用来表示当前消息唯一性。 </li>
<li>消息只要被 broker 接收到就会执行 confirmCallback，如果是 cluster 模式，需要所有 broker 接收到才会调用 confirmCallback。 </li>
<li>被 broker 接收到只能表示 message 已经到达服务器，并不能保证消息一定会被投递 到目标 queue 里。所以需要用到接下来的 returnCallback 。</li>
</ul>
<pre class=" language-JAVA"><code class="language-JAVA">/* 定制RabbitTemplate
  * 1、服务器收到消息就回调
  *     1、spring.rabbitmq.publisher-confirms=true
  *     2、设置确认回调ConfirmCallback
  * */
  @PostConstruct//MyRabbitConfig对象创建以后执行这个方法
  public void initRabbitTemplate(){
    // 设置确认回调
    rabbitTemplate.setConfirmCallback(
        new RabbitTemplate.ConfirmCallback() {
          /**
           * 1、只要消息抵达Broker就b=true
           *
           * @param correlationData 当前消息的唯一关联数据(唯一id) 发送消息端携带
           * @param b 消息是否成功收到
           * @param s 失败原因
           */
          @Override
          public void confirm(CorrelationData correlationData, boolean b, String s) {
            System.out.println("correlationData"+s+",b"+b+",s"+s);
          }
        });
  }
</code></pre>
<blockquote>
<p>可靠抵达-ReturnCallback</p>
</blockquote>
<p>==spring.rabbitmq.publisher-returns=true==</p>
<p>==spring.rabbitmq.template.mandatory=true==</p>
<ul>
<li>confrim 模式只能保证消息到达 broker，不能保证消息准确投递到目标 queue 里。在有些业务场景下，我们需要保证消息一定要投递到目标 queue 里，此时就需要用到 return 退回模式。 </li>
<li>这样如果未能投递到目标 queue 里将调用 returnCallback ，可以记录下详细到投递数据，定期的巡检或者自动纠错都需要这些数据</li>
</ul>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/* 定制RabbitTemplate
 * 1、服务器收到消息就回调
 *     1、spring.rabbitmq.publisher-confirms=true
 *     2、设置确认回调回调ConfirmCallback
 * 2、消息正确抵达队列进行回调
 *     1、spring.rabbitmq.publisher-returns=true
 *     2、spring.rabbitmq.template.mandatory=true
 *     3、设置确认回调ReturnCallback
 * */</span>
<span class="token annotation punctuation">@PostConstruct</span> <span class="token comment" spellcheck="true">// MyRabbitConfig对象创建以后执行这个方法</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initRabbitTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// 设置确认回调</span>
  rabbitTemplate<span class="token punctuation">.</span><span class="token function">setConfirmCallback</span><span class="token punctuation">(</span>
      <span class="token keyword">new</span> <span class="token class-name">RabbitTemplate<span class="token punctuation">.</span>ConfirmCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">/**
         * 1、只要消息抵达Broker就b=true
         *
         * @param correlationData 当前消息的唯一关联数据(唯一id) 发送消息端携带
         * @param b 消息是否成功收到
         * @param s 失败原因
         */</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">confirm</span><span class="token punctuation">(</span>CorrelationData correlationData<span class="token punctuation">,</span> <span class="token keyword">boolean</span> b<span class="token punctuation">,</span> String s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"correlationData"</span> <span class="token operator">+</span> s <span class="token operator">+</span> <span class="token string">",b"</span> <span class="token operator">+</span> b <span class="token operator">+</span> <span class="token string">",s"</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">// 设置消息抵达队列的确认回调</span>
  rabbitTemplate<span class="token punctuation">.</span><span class="token function">setReturnCallback</span><span class="token punctuation">(</span>
      <span class="token keyword">new</span> <span class="token class-name">RabbitTemplate<span class="token punctuation">.</span>ReturnCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">/**
         * 只要消息没有成功抵达消息队列，触发失败回调
         * @param message 投递失败的消息的详细信息
         * @param i 回复的状态码
         * @param s 回复的文本内容
         * @param s1 当时这个消息是哪个交换机发的
         * @param s2 当时这个消息用的那个路由键
         */</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">returnedMessage</span><span class="token punctuation">(</span>Message message<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">,</span> String s<span class="token punctuation">,</span> String s1<span class="token punctuation">,</span> String s2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Fail Message["</span><span class="token operator">+</span>message<span class="token operator">+</span><span class="token string">"]"</span><span class="token operator">+</span><span class="token string">"状态码"</span><span class="token operator">+</span>i<span class="token operator">+</span><span class="token string">"文本"</span><span class="token operator">+</span><span class="token string">"s"</span><span class="token operator">+</span><span class="token string">"exchange"</span><span class="token operator">+</span>s1<span class="token operator">+</span><span class="token string">"路由键"</span><span class="token operator">+</span>s2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<blockquote>
<p>可靠抵达-Ack消息确认机制</p>
</blockquote>
<ul>
<li>消费者获取到消息，成功处理，可以回复Ack给Broker <ul>
<li>basic.ack用于肯定确认；broker将移除此消息</li>
<li>basic.nack用于否定确认；可以指定broker是否丢弃此消息，可以批量</li>
<li>basic.reject用于否定确认；同上，但不能批量</li>
</ul>
</li>
<li>默认自动ack，消息被消费者收到，就会从broker的queue中移除 </li>
<li>queue无消费者，消息依然会被存储，直到消费者消费 </li>
<li>消费者收到消息，默认会自动ack。但是如果无法确定此消息是否被处理完成,或者成功处理。我们可以开启手动ack模式 <ul>
<li>消息处理成功，ack()，接受下一个消息，此消息broker就会移除</li>
<li>消息处理失败，nack()/reject()，重新发送给其他人进行处理，或者容错处理后ack</li>
<li>消息一直没有调用ack/nack方法，broker认为此消息正在被处理，不会投递给别人，此时客户端断开，消息不会被broker移除，会投递给别人</li>
</ul>
</li>
</ul>
<pre class=" language-java"><code class="language-java"><span class="token operator">*</span> <span class="token number">3</span>、消费端确认（保证每一条消息被正确消费<span class="token punctuation">,</span>此时才可以broker删除这个消息）
<span class="token operator">*</span>      spring<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>listener<span class="token punctuation">.</span>simple<span class="token punctuation">.</span>acknowledge<span class="token operator">-</span>mode<span class="token operator">=</span>manual
<span class="token operator">*</span>     <span class="token number">1</span>、默认是自动确认的，只要接受到消息，客户端会自动确认，服务端就会删除这条消息
<span class="token operator">*</span>        问题：
<span class="token operator">*</span>           我们收到很多消息，自动回复给服务器，只有一个消息处理，然后宕机，发现消息丢失
<span class="token operator">*</span>           手动确认：只要没有确认 ，消息就还在
<span class="token operator">*</span>     <span class="token number">2</span>、如何签收
<span class="token operator">*</span>          签收消息 channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>deliveryTag<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">*</span>          拒签消息 channel<span class="token punctuation">.</span><span class="token function">basicNack</span><span class="token punctuation">(</span>deliveryTag<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>配置</p>
<p>#手动ack消息<br>==spring.rabbitmq.listener.simple.acknowledge-mode=manual==</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//chanel内按顺序自增</span>
<span class="token keyword">long</span> deliveryTag <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
   <span class="token comment" spellcheck="true">//签收消息 false非批量 true批量</span>
   channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>deliveryTag<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment" spellcheck="true">//拒签消息 第二个参数是否批量 第三个参数是否从新放回队列</span>
   <span class="token comment" spellcheck="true">//channel.basicNack(deliveryTag,false,true);</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h2><span id="延时队列">延时队列</span></h2><p>使用场景</p>
<p>比如未付款订单，超过一定时间后，系统自动取消订单并释放占有物品。</p>
<p><strong>常用解决方案：</strong> </p>
<p>spring的 schedule 定时任务轮询数据库 </p>
<p><strong>缺点：</strong> </p>
<p>消耗系统内存、增加了数据库的压力、存在较大的时间误差 </p>
<p><strong>解决：</strong>rabbitmq的消息TTL和死信Exchange结合</p>
<blockquote>
<p>消息的TTL（Time To Live）</p>
</blockquote>
<ul>
<li>消息的TTL就是消息的存活时间。</li>
<li>RabbitMQ可以对队列和消息分别设置TTL。<ul>
<li>对队列设置就是队列没有消费者连着的保留时间，也可以对每一个单独的消息做单独的设置。超过了这个时间，我们认为这个消息就死了，称之为死信。</li>
<li>如果队列设置了，消息也设置了，那么会取小的。所以一个消息如果被路由到不同的队列中，这个消息死亡的时间有可能不一样（不同的队列设置）。这里单讲单个消息的TTL，因为它才是实现延迟任务的关键。可以通过设置消息的expiration字段或者x-message-ttl属性来设置时间，两者是一样的效果。</li>
</ul>
</li>
</ul>
<blockquote>
<p>Dead Letter Exchanges（DLX） </p>
</blockquote>
<ul>
<li>一个消息在满足如下条件下，会进死信路由，记住这里是路由而不是队列，一个路由可以对应很多队列。（什么是死信） <ul>
<li>一个消息被Consumer拒收了，并且reject方法的参数里requeue是false。也就是说不会被再次放在队列里，被其他消费者使用。（basic.reject/ basic.nack）requeue=false</li>
<li>上面的消息的TTL到了，消息过期了。</li>
<li>队列的长度限制满了。排在前面的消息会被丢弃或者扔到死信路由上 </li>
</ul>
</li>
<li>Dead Letter Exchange其实就是一种普通的exchange，和创建其他exchange没有两样。只是在某一个设置Dead Letter Exchange的队列中有消息过期了，会自动触发消息的转发，发送到Dead Letter Exchange中去。</li>
<li>我们既可以控制消息在一段时间后变成死信，又可以控制变成死信的消息被路由到某一个指定的交换机，结合二者，其实就可以实现一个延时队列</li>
<li>手动ack&amp;异常消息统一放在一个队列处理建议的两种方式<ul>
<li>catch异常后，<strong>手动发送到指定队列</strong>，然后使用channel给rabbitmq确认消息已消费</li>
<li>给Queue绑定死信队列，使用nack（requque为false）确认消息消费失败</li>
</ul>
</li>
</ul>
<h1><span id="简单整合rabbitmq测试">简单整合RabbitMQ测试</span></h1><ol>
<li><strong>引入</strong> spring-boot-starter-amqp</li>
<li><strong>application.yml</strong>配置</li>
<li><strong>测试RabbitMQ</strong><ol>
<li><strong>AmqpAdmin</strong>：管理组件</li>
<li><strong>RabbitTemplate</strong>：消息发送处理组件</li>
<li>@RabbitListener 监听消息的方法可以有三种参数（不分数量，顺序） 类+方法上</li>
<li>@RabbieHandler 方法上 (结合@RabbitListener使用，重载区分不同的消息)</li>
</ol>
</li>
</ol>
<blockquote>
<p>order服务</p>
</blockquote>
<ol>
<li><p>引入依赖</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
</code></pre>
</li>
<li><p>配置文件</p>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">spring.rabbitmq.host</span><span class="token punctuation">=</span><span class="token attr-value">192.168.67.217</span>
<span class="token attr-name">spring.rabbitmq.port</span><span class="token punctuation">=</span><span class="token attr-value">5672</span>
<span class="token attr-name">spring.rabbitmq.virtual-host</span><span class="token punctuation">=</span><span class="token attr-value">/</span>
</code></pre>
</li>
<li><p>开启功能<code>@EnableRabbit</code></p>
</li>
<li><p>测试</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>lpc<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>order<span class="token punctuation">;</span>

<span class="token keyword">import</span> lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span>Slf4j<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>Test<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runner<span class="token punctuation">.</span>RunWith<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span>AmqpAdmin<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span>Binding<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span>DirectExchange<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span>Queue<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Autowired<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>SpringBootTest<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span>SpringRunner<span class="token punctuation">;</span>

<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span>SpringRunner<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GulimallOrderApplicationTests</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">/* 1、如何创建Exchange、Queue、Binding
   *     1)、使用AmqpAdmin进项创建
   * 2、如何发消息
   * */</span>
  <span class="token annotation punctuation">@Autowired</span> AmqpAdmin amqpAdmin<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@Test</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 创建交换机对象</span>
    <span class="token comment" spellcheck="true">// DirectExchange(String name, boolean durable, boolean autoDelete, Map&lt;String, Object></span>
    <span class="token comment" spellcheck="true">// arguments)</span>
    DirectExchange directExchange <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DirectExchange</span><span class="token punctuation">(</span><span class="token string">"hello-java-exchange"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    amqpAdmin<span class="token punctuation">.</span><span class="token function">declareExchange</span><span class="token punctuation">(</span>directExchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Exchange[{}]创建成功"</span><span class="token punctuation">,</span> <span class="token string">"hello-java-exchange"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Test</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 创建队列</span>
    <span class="token comment" spellcheck="true">// Queue(String name, boolean durable, boolean exclusive, boolean autoDelete, Map&lt;String,</span>
    <span class="token comment" spellcheck="true">// Object> arguments)</span>
    Queue queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token string">"hello-java-queue"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    amqpAdmin<span class="token punctuation">.</span><span class="token function">declareQueue</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Queue[{}]创建成功"</span><span class="token punctuation">,</span> <span class="token string">"hello-java-queue"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Test</span>
  <span class="token comment" spellcheck="true">//绑定</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createBinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//    destination 目的地</span>
    <span class="token comment" spellcheck="true">//    DestinationType目的地类型</span>
    <span class="token comment" spellcheck="true">//    exchange交换机</span>
    <span class="token comment" spellcheck="true">//    routingKey 路由键</span>
    <span class="token comment" spellcheck="true">// Binding(String destination, Binding.DestinationType destinationType, String exchange, String</span>
    <span class="token comment" spellcheck="true">// routingKey, Map&lt;String, Object> arguments)</span>
    <span class="token comment" spellcheck="true">//将exchange指定的交换机和指定的目的地绑定，使用路由键</span>
    Binding binding <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Binding</span><span class="token punctuation">(</span><span class="token string">"hello-java-queue"</span><span class="token punctuation">,</span>
            Binding<span class="token punctuation">.</span>DestinationType<span class="token punctuation">.</span>QUEUE<span class="token punctuation">,</span><span class="token string">"hello-java-exchange"</span><span class="token punctuation">,</span><span class="token string">"hello-java"</span><span class="token punctuation">,</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
    amqpAdmin<span class="token punctuation">.</span><span class="token function">declareBinding</span><span class="token punctuation">(</span>binding<span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Binding[{}]创建成功"</span><span class="token punctuation">,</span> <span class="token string">"hello-java-binding"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>使用消息转换器</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>lpc<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>config<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>support<span class="token punctuation">.</span>converter<span class="token punctuation">.</span>Jackson2JsonMessageConverter<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>support<span class="token punctuation">.</span>converter<span class="token punctuation">.</span>MessageConverter<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Bean<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Configuration<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 *@author: lpc
 *@date: 30/12/2021 下午 6:33
 *@describe:
 *@vision
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyRabbitConfig</span> <span class="token punctuation">{</span>

  <span class="token annotation punctuation">@Bean</span>
  <span class="token keyword">public</span> MessageConverter <span class="token function">messageConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Jackson2JsonMessageConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>发消息</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Autowired</span> RabbitTemplate rabbitTemplate<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendMessageTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// 1、发送消息</span>
  OrderReturnReasonEntity entity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderReturnReasonEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  entity<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>1l<span class="token punctuation">)</span><span class="token punctuation">;</span>
  entity<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  entity<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"呵呵"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">"hello-java-exchange"</span><span class="token punctuation">,</span><span class="token string">"hello-java"</span><span class="token punctuation">,</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
  log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"消息发送完成{}"</span><span class="token punctuation">,</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>接收消息</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// queues监听的所有队列</span>
<span class="token comment" spellcheck="true">// 类型org.springframework.amqp.core.Message</span>
<span class="token comment" spellcheck="true">//  参数可以写一下类型</span>
<span class="token comment" spellcheck="true">//  1、Message message，原生消息详细信息  头+体</span>
<span class="token comment" spellcheck="true">//  2、T&lt;发送的消息类型>  用什么类型发，用什么类型收</span>
<span class="token comment" spellcheck="true">//  3、Channel channel 当前传输数据的通道</span>
<span class="token comment" spellcheck="true">//  Queue：可以有很多人来监听，但只有一个能接收到消息</span>
<span class="token comment" spellcheck="true">// 场景：</span>
<span class="token comment" spellcheck="true">//     1)、订单服务有多个  同一个消息，只有一个人能接收到</span>
<span class="token comment" spellcheck="true">//     2)、只有一个消息处理完，才能继续接受下一个消息</span>
<span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"hello-java-queue"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">recieveMessage</span><span class="token punctuation">(</span>Message message<span class="token punctuation">,</span> OrderReturnReasonEntity content<span class="token punctuation">,</span> Channel channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment" spellcheck="true">// "id":1,"name":"呵呵","sort":null,"status":null,"createTime":1640861388816}</span>
   <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment" spellcheck="true">// 消息头属性信息</span>
   MessageProperties properties <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"接受到的消息："</span> <span class="token operator">+</span> message <span class="token operator">+</span> <span class="token string">"内容=>"</span> <span class="token operator">+</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment" spellcheck="true">//chanel内按顺序自增</span>
   <span class="token keyword">long</span> deliveryTag <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">//签收消息 false非批量 true批量</span>
      channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>deliveryTag<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//拒签消息 第三个参数是否从新放回队列</span>
      <span class="token comment" spellcheck="true">//channel.basicNack(deliveryTag,false,true);</span>
   <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</li>
</ol>
<h1><span id="feigen失去请求头问题">Feigen失去请求头问题</span></h1><p>浏览器和Feign发请求有区别</p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20220101145913579.png" alt="image-20220101145913579"></p>
<p>解决(feign在执行远程调用前，会构造请求，期间会调用一些拦截器来增强这个请求(默认没有))</p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20220101150326845.png" alt="image-20220101150326845"></p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">"requestInterceptor"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> RequestInterceptor <span class="token function">requestInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RequestInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span>RequestTemplate requestTemplate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// 1、RequestContextHolder拿到刚进来的请求</span>
      ServletRequestAttributes attributes <span class="token operator">=</span>
          <span class="token punctuation">(</span>ServletRequestAttributes<span class="token punctuation">)</span> RequestContextHolder<span class="token punctuation">.</span><span class="token function">getRequestAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      HttpServletRequest request <span class="token operator">=</span> attributes<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">// 2、同步请求头  Cookie</span>
      String cookie <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"Cookie"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      requestTemplate<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Cookie"</span><span class="token punctuation">,</span> cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>异步出现问题</p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20220101155955059.png" alt="image-20220101155955059"></p>
<p>解决方法：异步执行之前放入数据</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//获取这个线程的请求数据</span>
RequestAttributes requestAttributes <span class="token operator">=</span> RequestContextHolder<span class="token punctuation">.</span><span class="token function">getRequestAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
CompletableFuture<span class="token operator">&lt;</span>Void<span class="token operator">></span> getAddressFuture <span class="token operator">=</span>
   CompletableFuture<span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span>
   <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">//执行远程之前把请求数据放入这个异步y</span>
      RequestContextHolder<span class="token punctuation">.</span><span class="token function">setRequestAttributes</span><span class="token punctuation">(</span>requestAttributes<span class="token punctuation">)</span><span class="token punctuation">;</span>
      List<span class="token operator">&lt;</span>MemberAddressVo<span class="token operator">></span> address <span class="token operator">=</span> memberFeignService<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span>memberRespVo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      confirmVo<span class="token punctuation">.</span><span class="token function">setMemberAddressVos</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span>
   executor<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h1><span id="接口幂等性问题解决方案">接口幂等性问题解决方案</span></h1><ol>
<li>token机制</li>
<li>各种锁机制</li>
<li>各种唯一约束</li>
<li>防重表</li>
<li>全局请求唯一id</li>
</ol>
<h2><span id="锁定库存逻辑">锁定库存逻辑</span></h2><p><img src="/2022/01/10/gulimall-bi-ji/image-20220103132327092.png" alt="image-20220103132327092"></p>
<h1><span id="分布式事务">分布式事务</span></h1><p><img src="/2022/01/10/gulimall-bi-ji/image-20220103150151689.png" alt="image-20220103150151689"></p>
<h2><span id="本地事务失效问题">本地事务失效问题：</span></h2><p>同一个对象内事务方法互调默认失效，原因，绕过了代理对象</p>
<p>事务使用代理对象来控制</p>
<p>解决：使用代理对象来调用事务方法</p>
<ol>
<li><p>引入aop-starter,他里边引入了aspectj</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-aop<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
</code></pre>
</li>
<li><p>启动类加入注解<code>@EnableAspectJAutoProxy</code>,开启aspectj动态代理功能，以后所有的动态代理都是aspectj创建的，好处没有接口也可以创建动态代理</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@EnableAspectJAutoProxy</span><span class="token punctuation">(</span>exposeProxy <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">//exposeProxy堆外暴露代理对象</span>
</code></pre>
</li>
<li><p>本类互调用代理对象</p>
<pre class=" language-JAVA"><code class="language-JAVA">//获取当前类代理对象
OrderServiceImpl orderService = (OrderServiceImpl) AopContext.currentProxy();//转为当前类对象
//调用本类方法(a方法里的事务也生效了)
orderService.a();
</code></pre>
</li>
</ol>
<h2><span id="cap-定理与-base-理论"><strong>CAP</strong> <strong>定理与</strong> <strong>BASE</strong> <strong>理论</strong></span></h2><ol>
<li><p><strong>CAP</strong> <strong>定理</strong> </p>
<p>CAP 原则又称 CAP 定理，指的是在一个分布式系统中</p>
<ul>
<li>一致性（Consistency）：<ul>
<li>在分布式系统中的所有数据备份，在同一时刻是否同样的值。（等同于所有节点访问同一份最新的数据副本） </li>
</ul>
</li>
<li>可用性（Availability）<ul>
<li>在集群中一部分节点故障后，集群整体是否还能响应客户端的读写请求。（对数据 更新具备高可用性）</li>
</ul>
</li>
<li>分区容错性（Partition tolerance） <ul>
<li>大多数分布式系统都分布在多个子网络。每个子网络就叫做一个区（partition）。 分区容错的意思是，区间通信可能失败。比如，一台服务器放在中国，另一台服务器放在美国，这就是两个区，它们之间可能无法通信。 </li>
</ul>
</li>
</ul>
<p>CAP 原则指的是，这三个要素最多只能同时实现两点，<strong>不可能三者兼顾</strong>。</p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20220103182053917.png" alt="image-20220103182053917"></p>
<p>一般来说，分区容错无法避免，因此可以认为 CAP 的 P 总是成立。CAP 定理告诉我们，剩下的 C 和 A 无法同时做到。 </p>
<p>分布式系统中实现一致性的 raft 算法、paxos </p>
</li>
<li><p><strong>面临的问题</strong></p>
<p>对于多数大型互联网应用的场景，主机众多、部署分散，而且现在的集群规模越来越大，所以节点故障、网络故障是常态，而且要保证服务可用性达到 99.99999%（N 个 9）即保证 P 和 A，舍弃 C。</p>
</li>
<li><p><strong>BASE</strong> <strong>理论</strong> </p>
<p>是对 CAP 理论的延伸，思想是即使无法做到强一致性（CAP 的一致性就是强一致性），但可以采用适当的采取弱一致性，即<strong>最终一致性</strong>。</p>
<p>BASE 是指 ：</p>
<ul>
<li>基本可用（Basically Available）<ul>
<li>基本可用是指分布式系统在出现故障的时候，允许损失部分可用性（例如响应时间、功能上的可用性），允许损失部分可用性。需要注意的是，基本可用绝不等价于系统不可用。<ul>
<li>响应时间上的损失：正常情况下搜索引擎需要在 0.5 秒之内返回给用户相应的查询结果，但由于出现故障（比如系统部分机房发生断电或断网故障），查询结果的响应时间增加到了 1~2 秒。</li>
<li>功能上的损失：购物网站在购物高峰（如双十一）时，为了保护系统的稳定性，部分消费者可能会被引导到一个降级页面。 </li>
</ul>
</li>
</ul>
</li>
<li>软状态（ Soft State） <ul>
<li>软状态是指允许系统存在中间状态，而该中间状态不会影响系统整体可用性。分布式存储中一般一份数据会有多个副本，允许不同副本同步的延时就是软状态的体现。mysql replication 的异步复制也是一种体现。</li>
</ul>
</li>
<li>最终一致性（ Eventual Consistency）<ul>
<li>最终一致性是指系统中的所有数据副本经过一定时间后，最终能够达到一致的状态。弱一致性和强一致性相反，最终一致性是弱一致性的一种特殊情况。</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>强一致性、弱一致性、最终一致性</strong></p>
<p>从客户端角度，多进程并发访问时，更新过的数据在不同进程如何获取的不同策略，决定了不同的一致性。对于关系型数据库，要求更新过的数据能被后续的访问都能看到，这是<strong>强一致性</strong>。如果能容忍后续的部分或者全部访问不到，则是<strong>弱一致性</strong>。如果经过一段时间后要求能访问到更新后的数据，则是<strong>最终一致性</strong></p>
</li>
</ol>
<h2><span id="分布式事务几种方案"><strong>分布式事务几种方案</strong></span></h2><ol>
<li><strong>2PC</strong> <strong>模式</strong> </li>
<li><strong>柔性事务-TCC事务补偿型方案</strong> </li>
<li><strong>柔性事务-最大努力通知型方案</strong></li>
<li><strong>柔性事务-可靠消息+最终一致性方案（异步确保型）</strong></li>
</ol>
<h2><span id="使用seata解决分布式事务">使用SEATA解决分布式事务</span></h2><p><a target="_blank" rel="noopener" href="https://seata.io/zh-cn/docs/user/quickstart.html">https://seata.io/zh-cn/docs/user/quickstart.html</a></p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20220104103334489.png" alt="image-20220104103334489"></p>
<p>准备前提：所有微服务的数据库加入<code>undo_log</code>表</p>
<p>安装事务协调器<code>seata-server</code>:<a target="_blank" rel="noopener" href="https://github.com/seata/seata/releases">https://github.com/seata/seata/releases</a></p>
<ol>
<li><p>导入依赖  seata-all:0.7.1</p>
<pre class=" language-xml"><code class="language-xml"><span class="token comment" spellcheck="true">&lt;!--seata--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-alibaba-seata<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
</code></pre>
</li>
<li><p>解压启动seata-server</p>
<p>  registry.conf：注册中心配置,修改type = “nacos”</p>
</li>
<li><p>所有用到分布式事务的微服务使用seata DataSourceProxy代理数据源(0.9以后默认，不用配置了)</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>lpc<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>config<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>zaxxer<span class="token punctuation">.</span>hikari<span class="token punctuation">.</span>HikariDataSource<span class="token punctuation">;</span>
<span class="token keyword">import</span> io<span class="token punctuation">.</span>seata<span class="token punctuation">.</span>rm<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span>DataSourceProxy<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Autowired<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>DataSourceProperties<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Bean<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Configuration<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span>StringUtils<span class="token punctuation">;</span>

<span class="token keyword">import</span> javax<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>DataSource<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * @author: lpc
 * @date: 4/1/2022 上午 11:50
 * @describe:
 * @vision
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MySeataConfig</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Autowired</span> DataSourceProperties dataSourceProperties<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@Bean</span>
  <span class="token keyword">public</span> DataSource <span class="token function">dataSource</span><span class="token punctuation">(</span>DataSourceProperties dataSourceProperties<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    HikariDataSource hikariDataSource <span class="token operator">=</span>
        dataSourceProperties<span class="token punctuation">.</span><span class="token function">initializeDataSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span>HikariDataSource<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>dataSourceProperties<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      hikariDataSource<span class="token punctuation">.</span><span class="token function">setPoolName</span><span class="token punctuation">(</span>dataSourceProperties<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DataSourceProxy</span><span class="token punctuation">(</span>hikariDataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</li>
<li><p>每个微服务,都必须导入 <code>registry.conf </code>和  <code>file.conf</code>，file.conf里边的名字必须个当前应用名一致</p>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">vgroup_mapping.gulimall-order-fescar-service-group</span> <span class="token punctuation">=</span> <span class="token attr-value">"default"</span>
</code></pre>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20220104120702681.png" alt="image-20220104120702681"></p>
<p>不想改名字的话，有一个配置，也可以</p>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">spring.cloud.alibaba.seata.tx-service-group</span><span class="token punctuation">=</span><span class="token attr-value">gulimall-order-fescar-service-group</span>
</code></pre>
</li>
<li><p>启动测试</p>
</li>
<li><p>给分布式大事务的入口标注@GlobalTransactional</p>
</li>
<li><p>每个远程的小事务@Transactional</p>
</li>
</ol>
<h2><span id="使用延时队列解决分布式事务">使用延时队列解决分布式事务</span></h2><p><img src="/2022/01/10/gulimall-bi-ji/image-20220104190808406.png" alt="image-20220104190808406"></p>
<p>订单服务</p>
<p>创建模型</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>lpc<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>config<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span>Binding<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span>Exchange<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span>Queue<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span>TopicExchange<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Bean<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Configuration<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>HashMap<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * @author: lpc
 * @date: 4/1/2022 下午 7:09
 * @describe:
 * @vision
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyMqConfig</span> <span class="token punctuation">{</span>
   <span class="token comment" spellcheck="true">//监听过期队列</span>
   <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">"order.release.order. queue"</span><span class="token punctuation">)</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listener</span><span class="token punctuation">(</span>OrderEntity entity<span class="token punctuation">,</span> Channel channel<span class="token punctuation">,</span> Message message<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
      System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"收到过期的订单信息，准备关闭订单"</span><span class="token operator">+</span>entity<span class="token punctuation">.</span><span class="token function">getOrderSn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment" spellcheck="true">// 这些组件都会自动创建(RabbitMQ中没有)</span>
   <span class="token annotation punctuation">@Bean</span>
   <span class="token keyword">public</span> Queue <span class="token function">orderDelayQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// String name, boolean durable, boolean exclusive, boolean autoDelete, Map&lt;String, Object></span>
      <span class="token comment" spellcheck="true">// arguments</span>
      Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> arguments <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">/*
    x-dead-letter-exchange: order-event-exchange
    x-dead-letter-routing-key: order.release.order
    x-message-ttl: 60000
     */</span>
      arguments<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"x-dead-letter-exchange"</span><span class="token punctuation">,</span> <span class="token string">"order-event-exchange"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      arguments<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"x-dead-letter-routing-key"</span><span class="token punctuation">,</span> <span class="token string">"order.release.order"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      arguments<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"x-message-ttl"</span><span class="token punctuation">,</span> <span class="token number">60000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      Queue queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token string">"order.delay.queue"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> queue<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Bean</span>
   <span class="token keyword">public</span> Queue <span class="token function">orderReleaseOrderQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Queue queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token string">"order.release.order. queue"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> queue<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Bean</span>
   <span class="token keyword">public</span> Exchange <span class="token function">orderEventExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// String name, boolean durable, boolean autoDelete, Map&lt;String, Object> arguments</span>
      TopicExchange topicExchange <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TopicExchange</span><span class="token punctuation">(</span><span class="token string">"order-event-exchange"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> topicExchange<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Bean</span>
   <span class="token keyword">public</span> Binding <span class="token function">orderCreateOrderBinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// String destination, Binding.DestinationType destinationType, String exchange, String</span>
      <span class="token comment" spellcheck="true">// routingKey, Map&lt;String, Object> arguments</span>
      Binding binding <span class="token operator">=</span>
         <span class="token keyword">new</span> <span class="token class-name">Binding</span><span class="token punctuation">(</span>
         <span class="token string">"order.delay.queue"</span><span class="token punctuation">,</span>
         Binding<span class="token punctuation">.</span>DestinationType<span class="token punctuation">.</span>QUEUE<span class="token punctuation">,</span>
         <span class="token string">"order-event-exchange"</span><span class="token punctuation">,</span>
         <span class="token string">"order.create.order"</span><span class="token punctuation">,</span>
         null<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> binding<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Bean</span>
   <span class="token keyword">public</span> Binding <span class="token function">orderReleaseOrderBinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Binding binding <span class="token operator">=</span>
         <span class="token keyword">new</span> <span class="token class-name">Binding</span><span class="token punctuation">(</span>
         <span class="token string">"order.release.order. queue"</span><span class="token punctuation">,</span>
         Binding<span class="token punctuation">.</span>DestinationType<span class="token punctuation">.</span>QUEUE<span class="token punctuation">,</span>
         <span class="token string">"order-event-exchange"</span><span class="token punctuation">,</span>
         <span class="token string">"order.release.order"</span><span class="token punctuation">,</span>
         null<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> binding<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>库存服务</p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20220105104619442.png" alt="image-20220105104619442"></p>
<p>具体在代码里</p>
<h3><span id="保证消息可靠性">保证消息可靠性</span></h3><blockquote>
<p>如何保证消息可靠性-==消息丢失==</p>
</blockquote>
<ol>
<li>消息丢失<ul>
<li>消息发送出去，由于网络问题没有抵达服务器 <ul>
<li>做好容错方法（try-catch），发送消息可能会网络失败，失败后要有重试机制，可记录到数据库，采用定期扫描重发的方式</li>
<li>做好日志记录，每个消息状态是否都被服务器收到都应该记录 </li>
<li>做好定期重发，如果消息没有发送成功，定期去数据库扫描未成功的消息进行重发 </li>
</ul>
</li>
<li>• 消息抵达Broker，Broker要将消息写入磁盘（持久化）才算成功。此时Broker尚未持久化完成，宕机。<ul>
<li>publisher也必须加入确认回调机制，确认成功的消息，修改数据库消息状态。</li>
</ul>
</li>
<li>自动ACK的状态下。消费者收到消息，但没来得及消息然后宕机 <ul>
<li>一定开启手动ACK，消费成功才移除，失败或者没来得及处理就noAck并重新入队</li>
</ul>
</li>
</ul>
</li>
</ol>
<blockquote>
<p>如何保证消息可靠性-==消息重复==</p>
</blockquote>
<ol>
<li>消息重复<ul>
<li>消息消费成功，事务已经提交，ack时，机器宕机。导致没有ack成功，Broker的消息重新由unack变为ready，并发送给其他消费者 </li>
<li>消息消费失败，由于重试机制，自动又将消息发送出去</li>
<li>成功消费，ack时宕机，消息由unack变为ready，Broker又重新发送<ul>
<li>消费者的业务消费接口应该设计为<strong>幂等性</strong>的。比如扣库存有工作单的状态标志</li>
<li>使用<strong>防重表</strong>（redis/mysql），发送消息每一个都有业务的唯一标识，处理过就不用处理 </li>
<li>rabbitMQ的每一个消息都有redelivered字段，可以获取<strong>是否是被重新投递过来的</strong>，而不是第一次投递过来的</li>
</ul>
</li>
</ul>
</li>
</ol>
<blockquote>
<p>如何保证消息可靠性-==消息积压==</p>
</blockquote>
<ol>
<li>消息积压<ul>
<li>消费者宕机积压 </li>
<li>消费者消费能力不足积压</li>
<li>发送者发送流量太大<ul>
<li>上线更多的消费者，进行正常消费 </li>
<li>上线专门的队列消费服务，将消息先批量取出来，记录数据库，离线慢慢处理</li>
</ul>
</li>
</ul>
</li>
</ol>
<h1><span id="内网穿透">内网穿透</span></h1><p><img src="/2022/01/10/gulimall-bi-ji/image-20220105211855363.png" alt="image-20220105211855363"></p>
<hr>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20220105211906799.png" alt="image-20220105211906799"></p>
<hr>
<p><a target="_blank" rel="noopener" href="https://i.xiaomy.net/#/">https://i.xiaomy.net/#/</a></p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20220105211927855.png" alt="image-20220105211927855"></p>
<hr>
<p>==nginx必须配置==</p>
<pre class=" language-bash"><code class="language-bash">listen       80<span class="token punctuation">;</span>
server_name gulimall.com  *.gulimall.com  vywc7tu7.dongtaiyuming.net<span class="token punctuation">;</span>

location /payed/ <span class="token punctuation">{</span>
proxy_set_header Host order.gulimall.com<span class="token punctuation">;</span>
proxy_pass http://gulimall<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20220106155949815.png" alt="image-20220106155949815"></p>
<h1><span id="定时任务和异步">定时任务和异步</span></h1><ol>
<li><p>@EnableScheduling开启定时任务功能</p>
<p>==自动配置类：TaskSchedulingAutoConfiguration==</p>
</li>
<li><p>@Scheduled开启定时任务</p>
<ul>
<li><p>spring中是由6位组成，没有第七位年</p>
</li>
<li><p>在周的位置，1-7分别是周一到周日</p>
</li>
<li><p>一般情况下，我们的定时任务不应该阻塞(默认是阻塞，会阻塞下一个定时任务,造成执行时间不一致)</p>
<ul>
<li>可以使用异步的方式，用自己的线程池</li>
</ul>
</li>
<li><p>支持定时任务线程池(默认里面只有一个连接，所以阻塞)，支持配置</p>
<ul>
<li><pre class=" language-properties"><code class="language-properties"><span class="token attr-name">spring.task.execution.pool.core-size</span><span class="token punctuation">=</span><span class="token attr-value">5</span>
</code></pre>
<p>不一定生效</p>
</li>
<li><p>让异步任务执行</p>
<p>@EnableAsync开启异步任务功能</p>
<p>==自动配置类：TaskExecutionAutoConfiguration==</p>
<p>里面默认大小是8个连接</p>
<p>@Async 这个方法是一个异步方法</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>解决：使用异步+定时任务来完成定时任务补阻塞功能</p>
</li>
</ol>
<h1><span id="分布式定时任务">分布式定时任务</span></h1><p><img src="/2022/01/10/gulimall-bi-ji/image-20220108165844144.png" alt="image-20220108165844144"></p>
<p>加入分布式锁</p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20220108165933306.png" alt="image-20220108165933306"></p>
<h1><span id="秒杀服务流量削峰">秒杀服务流量削峰</span></h1><p>使用redis和消息队列</p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20220105104036300.png" alt="image-20220109151246747"></p>
<h1><span id="整合sentinel">整合Sentinel</span></h1><p><a target="_blank" rel="noopener" href="https://github.com/alibaba/spring-cloud-alibaba/wiki/Sentinel">https://github.com/alibaba/spring-cloud-alibaba/wiki/Sentinel</a></p>
<ol>
<li><p>导入依赖</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-alibaba-sentinel<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
</code></pre>
</li>
<li><p>下载sentinel控制台</p>
<p>启动</p>
<pre class=" language-bash"><code class="language-bash">java -jar sentinel-dashboard-1.6.3.jar --server.port<span class="token operator">=</span>8333
</code></pre>
</li>
<li><p>加入配置，配置控制台地址信息</p>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">spring.cloud.sentinel.transport.dashboard</span><span class="token punctuation">=</span><span class="token attr-value">localhost:8333</span>
<span class="token attr-name">spring.cloud.sentinel.transport.port</span><span class="token punctuation">=</span><span class="token attr-value">8719</span>
</code></pre>
</li>
<li><p>在控制台调整参数，【默认所有的流控设置默认保存在内存中，重启失效】</p>
</li>
</ol>
<h2><span id="流控限流">流控/限流</span></h2><h3><span id="信息审计模块endpoint">信息审计模块Endpoint</span></h3><p>每个微服务都导入</p>
<ol>
<li><p>导入依赖</p>
<pre class=" language-XML"><code class="language-XML"><dependency>
   <groupid>org.springframework.boot</groupid>
   <artifactid>spring-boot-starter-actuator</artifactid>
</dependency>
</code></pre>
</li>
<li><p>暴露endpoint 路径</p>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">management.endpoints.web.exposure.include</span><span class="token punctuation">=</span><span class="token attr-value">*</span>
</code></pre>
</li>
<li><p>自定义流控返回</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>lpc<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>seckill<span class="token punctuation">.</span>config<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>adapter<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>callback<span class="token punctuation">.</span>UrlBlockHandler<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>adapter<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>callback<span class="token punctuation">.</span>WebCallbackManager<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>block<span class="token punctuation">.</span>BlockException<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>JSON<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>lpc<span class="token punctuation">.</span>common<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>BizCodeEnum<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>lpc<span class="token punctuation">.</span>common<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>R<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Configuration<span class="token punctuation">;</span>

<span class="token keyword">import</span> javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span>HttpServletRequest<span class="token punctuation">;</span>
<span class="token keyword">import</span> javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span>HttpServletResponse<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * @author: lpc
 * @date: 10/1/2022 下午 12:39
 * @describe: 阻塞返回
 * @vision
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SeckillSentinelConfig</span> <span class="token punctuation">{</span>
   <span class="token keyword">public</span> <span class="token function">SeckillSentinelConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      WebCallbackManager<span class="token punctuation">.</span><span class="token function">setUrlBlockHandler</span><span class="token punctuation">(</span>
         <span class="token keyword">new</span> <span class="token class-name">UrlBlockHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">blocked</span><span class="token punctuation">(</span>
               HttpServletRequest httpServletRequest<span class="token punctuation">,</span>
               HttpServletResponse httpServletResponse<span class="token punctuation">,</span>
               BlockException e<span class="token punctuation">)</span>
               <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
               R r <span class="token operator">=</span>
                  R<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>
                  BizCodeEnum<span class="token punctuation">.</span>TO_MANY_REQUEST<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> BizCodeEnum<span class="token punctuation">.</span>TO_MANY_REQUEST<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               httpServletResponse<span class="token punctuation">.</span><span class="token function">setCharacterEncoding</span><span class="token punctuation">(</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               httpServletResponse<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">"application/json"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               httpServletResponse<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</li>
</ol>
<h2><span id="熔断降级">熔断降级</span></h2><p>保护Feign的远程调用</p>
<h4><span id="调用方熔断">调用方熔断：</span></h4><ol>
<li><p>导入依赖<code>spring-cloud-starter-openfeign</code>，还有<code>spring-cloud-starter-alibaba-sentinel</code>,我们的服务都导入了</p>
</li>
<li><p>配置文件打开 Sentinel 对 Feign 的支持<code>feign.sentinel.enabled=true</code></p>
</li>
<li><p>改代码</p>
<p>远程【可能会出现错误的调用，假设远程服务宕机】</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>lpc<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>product<span class="token punctuation">.</span>feign<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>lpc<span class="token punctuation">.</span>common<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>R<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>lpc<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>product<span class="token punctuation">.</span>feign<span class="token punctuation">.</span>fallback<span class="token punctuation">.</span>SeckillFeignServiceFallBcak<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span>FeignClient<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>GetMapping<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>PathVariable<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * @author: lpc
 * @date: 9/1/2022 上午 11:33
 * @describe:
 * @vision
 */</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"gulimall-seckill"</span><span class="token punctuation">,</span> fallback <span class="token operator">=</span> SeckillFeignServiceFallBcak<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SeckillFeignService</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/sku/seckill/{skuId}"</span><span class="token punctuation">)</span>
  R <span class="token function">getSkuSeckillInfo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"skuId"</span><span class="token punctuation">)</span> Long skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>熔断【如果调用失败，就返回这个熔断方法】</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>lpc<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>product<span class="token punctuation">.</span>feign<span class="token punctuation">.</span>fallback<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>lpc<span class="token punctuation">.</span>common<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>BizCodeEnum<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>lpc<span class="token punctuation">.</span>common<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>R<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>lpc<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>product<span class="token punctuation">.</span>feign<span class="token punctuation">.</span>SeckillFeignService<span class="token punctuation">;</span>
<span class="token keyword">import</span> lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span>Slf4j<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span>Component<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * @author: lpc
 * @date: 10/1/2022 下午 1:38
 * @describe:
 * @vision
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SeckillFeignServiceFallBcak</span> <span class="token keyword">implements</span> <span class="token class-name">SeckillFeignService</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> R <span class="token function">getSkuSeckillInfo</span><span class="token punctuation">(</span>Long skuId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"熔断方法调用。。。getSkuSeckillInfo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> R<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>BizCodeEnum<span class="token punctuation">.</span>TO_MANY_REQUEST<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> BizCodeEnum<span class="token punctuation">.</span>TO_MANY_REQUEST<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</li>
</ol>
<h4><span id="调用方降级">调用方降级：</span></h4><p>手动加入降级策略：</p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20220110135050091.png" alt="image-20220110135050091"></p>
<p>例：指定远程超过指定时间，就降级调用我自己的熔断</p>
<p>远程没有达到我的标准，我就降级，去执行我自己的策略</p>
<p>这些标准有RT、异常比例、异常数等</p>
<h4><span id="被调用方">被调用方：</span></h4><p>也可以指定流控和降级</p>
<p>使用场景：超大流量的时候，必须牺牲一些远程服务，就可以使用降级策略，远程过来的请求，我不执行业务，我直接降级返回我熔断的数据</p>
<p>全局考虑，一般不建议使用</p>
<h2><span id="自定义受保护的资源">自定义受保护的资源</span></h2><h3><span id="代码方式">代码方式:</span></h3><pre class=" language-JAVA"><code class="language-JAVA">try(Entry entry = SphU.entry("SeckillSkus")){
   //业务...
}catch(BlockException e){
   log.info("资源被限流。。。");
}
</code></pre>
<p>控制台里会有SeckillSkus，我们可以对他进行限流和降级，如果不满足标准就会执行catch</p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20220110142157595.png" alt="image-20220110142157595"></p>
<h3><span id="注解方式">注解方式</span></h3><p><code>@SentinelResource</code> 注解用来标识资源是否被限流、降级。</p>
<p><code>@SentinelResource</code> 还提供了其它额外的属性如 <code>blockHandler</code>，<code>blockHandlerClass</code>，<code>fallback</code> 用于表示限流或降级的操作（注意有方法签名要求），更多内容可以参考 <a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/wiki/%E6%B3%A8%E8%A7%A3%E6%94%AF%E6%8C%81">Sentinel 注解支持文档</a>。</p>
<p>若不配置 <code>blockHandler</code>、<code>fallback</code> 等函数，则被流控降级时方法会直接抛出对应的 BlockException；若方法未定义 <code>throws BlockException</code> 则会被 JVM 包装一层 <code>UndeclaredThrowableException</code>。</p>
<blockquote>
<p>注：一般推荐将 <code>@SentinelResource</code> 注解加到服务实现上，而在 Web 层直接使用 Spring Cloud Alibaba 自带的 Web 埋点适配。Sentinel Web 适配同样支持配置自定义流控处理逻辑，参考 <a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/wiki/%E4%B8%BB%E6%B5%81%E6%A1%86%E6%9E%B6%E7%9A%84%E9%80%82%E9%85%8D#web-%E9%80%82%E9%85%8D">相关文档</a>。</p>
</blockquote>
<pre class=" language-java"><code class="language-java">List<span class="token operator">&lt;</span>SeckillSkuRedisTo<span class="token operator">></span><span class="token function">blockHandler</span><span class="token punctuation">(</span>BlockException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"getCurrentSeckillSkusResource被限流了"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> null<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">"getCurrentSeckillSkusResource"</span><span class="token punctuation">,</span>blockHandler <span class="token operator">=</span> <span class="token string">"blockHandler"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> List<span class="token operator">&lt;</span>SeckillSkuRedisTo<span class="token operator">></span> <span class="token function">getCurrentSeckillSkus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment" spellcheck="true">//业务</span>
<span class="token punctuation">}</span>
</code></pre>
<p>@SentinelResource标注这个保护的方法，如果没有达到一些标准(限流/降级策略)，就去执行blockHandler指定的熔断方法(这个方法参数和原方法参数一样，可以带一个默认的BlockException来获取异常原因)</p>
<p>blockHandler：针对于指定方法被降级的调用</p>
<p>fallback：抛出异常执行逻辑 </p>
<p><a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/wiki/%E6%B3%A8%E8%A7%A3%E6%94%AF%E6%8C%81">注解支持</a></p>
<p>==无论是哪种方式，一定要配置被限流后的默认返回==</p>
<p>url请求可以设置统一返回 WebCallbackManager 上边限流有</p>
<h2><span id="网关流控">网关流控</span></h2><p><a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/wiki/%E7%BD%91%E5%85%B3%E9%99%90%E6%B5%81">https://github.com/alibaba/Sentinel/wiki/%E7%BD%91%E5%85%B3%E9%99%90%E6%B5%81</a></p>
<ol>
<li><p>引入依赖</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-alibaba-sentinel-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.1.0.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
</code></pre>
<p>启动网关</p>
</li>
<li><p>使用新版控制台可以感知到请求的路由</p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20220110150204092.png" alt="image-20220110150204092"></p>
<p>可以做一些限制</p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20220110150329150.png" alt="image-20220110150329150"></p>
</li>
</ol>
<h2><span id="网关流控返回">网关流控返回</span></h2><pre class=" language-JAVA"><code class="language-JAVA">package com.lpc.gulimall.gateway.config;

import com.alibaba.csp.sentinel.adapter.gateway.sc.callback.BlockRequestHandler;
import com.alibaba.csp.sentinel.adapter.gateway.sc.callback.GatewayCallbackManager;
import com.alibaba.fastjson.JSON;
import com.lpc.common.exception.BizCodeEnum;
import com.lpc.common.utils.R;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.reactive.function.server.ServerResponse;
import org.springframework.web.server.ServerWebExchange;
import reactor.core.publisher.Mono;

/**
 * @author: lpc
 * @date: 10/1/2022 下午 3:12
 * @describe:
 * @vision
 */
@Configuration
public class SentinelGagewayConfig {
   //TODO 响应式编程
  public SentinelGagewayConfig() {
    GatewayCallbackManager.setBlockHandler(
        new BlockRequestHandler() {
          // 网关限流了就调用此回调
          @Override
          public Mono<serverresponse> handleRequest(
              ServerWebExchange serverWebExchange, Throwable throwable) {
            R error =
                R.error(
                    BizCodeEnum.TO_MANY_REQUEST.getCode(), BizCodeEnum.TO_MANY_REQUEST.getMsg());
            String string = JSON.toJSONString(error);
            Mono<serverresponse> body = ServerResponse.ok().body(Mono.just(string), String.class);
            return body;
          }
        });
  }
}
</serverresponse></serverresponse></code></pre>
<h1><span id="sleuthzipkin服务链路追踪">Sleuth+Zipkin服务链路追踪</span></h1><h2><span id="整合sleuth">整合Sleuth</span></h2><ol>
<li><p>服务提供者与消费者导入依赖</p>
<pre class=" language-xml"><code class="language-xml"><span class="token comment" spellcheck="true">&lt;!--链路追踪--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-sleuth<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>3.1.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
</code></pre>
</li>
<li><p>打开 debug 日志 </p>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">logging.level.org.springframework.cloud.openfeign</span><span class="token punctuation">:</span> <span class="token attr-value">debug </span>
<span class="token attr-name">logging.level.org.springframework.cloud.sleuth</span><span class="token punctuation">:</span> <span class="token attr-value">debug</span>
</code></pre>
</li>
<li><p>发起一次远程调用，观察控制台 </p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20220110160510595.png" alt="image-20220110160510595"></p>
<p>DEBUG [user-service,541450f08573fff5,541450f08573fff5,false]</p>
<p>user-service：服务名 </p>
<p>541450f08573fff5：是 TranceId，一条链路中，只有一个 TranceId </p>
<p>541450f08573fff5：是 spanId，链路中的基本工作单元 id </p>
<p>false：表示是否将数据输出到其他服务，true 则会把信息输出到其他可视化的服务上观察</p>
</li>
</ol>
<h2><span id="整合zipkin可视化观察">整合zipkin可视化观察</span></h2><ol>
<li><p>docker 安装 zipkin 服务器</p>
<pre class=" language-bash"><code class="language-bash">docker run -d -p 9411:9411 openzipkin/zipkin
</code></pre>
</li>
<li><p>导入依赖</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span> 
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span> 
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-zipkin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
</code></pre>
<p>zipkin 依赖也同时包含了 sleuth，可以省略 sleuth 的引用</p>
</li>
<li><p>添加 zipkin 相关配置 </p>
<p><img src="/2022/01/10/gulimall-bi-ji/image-20220110161758025.png" alt="image-20220110161758025"></p>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">spring.zipkin.base-url</span><span class="token punctuation">=</span><span class="token attr-value">http://192.168.67.217:9411</span>
<span class="token attr-name">spring.zipkin.discovery-client-enabled</span><span class="token punctuation">=</span><span class="token attr-value">false</span>
<span class="token attr-name">spring.zipkin.sender.type</span><span class="token punctuation">=</span><span class="token attr-value">web</span>
<span class="token attr-name">spring.sleuth.sampler.probability</span><span class="token punctuation">=</span><span class="token attr-value">1</span>
</code></pre>
</li>
</ol>
<p><a target="_blank" rel="noopener" href="http://192.168.67.217:9411/zipkin/">http://192.168.67.217:9411/zipkin/</a></p>
<h2><span id="追踪数据持久化">追踪数据持久化</span></h2><p><a target="_blank" rel="noopener" href="https://github.com/openzipkin/zipkin#storage-component">https://github.com/openzipkin/zipkin#storage-component</a></p>
<p>通过 docker 的方式 </p>
<pre class=" language-bash"><code class="language-bash">docker run --env STORAGE_TYPE<span class="token operator">=</span>elasticsearch --env ES_HOSTS<span class="token operator">=</span>192.168.67.217:9200 openzipkin/zipkin-dependencies
</code></pre>
<h1><span id="总结">总结</span></h1><p><img src="/2022/01/10/gulimall-bi-ji/image-20220110171227575.png" alt="image-20220110171227575"></p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">DTXG</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://dtxt.github.io/2022/01/10/gulimall-bi-ji/">https://dtxt.github.io/2022/01/10/gulimall-bi-ji/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">DTXG</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/%E5%95%86%E5%9F%8E/">
                                    <span class="chip bg-color">商城</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2022/01/15/redis/">
                    <div class="card-image">
                        
                        <img src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fpic1.zhimg.com%2Fv2-68ba5c63fb878f074c4ac91e944b24a4_1440w.jpg%3Fsource%3D172ae18b&refer=http%3A%2F%2Fpic1.zhimg.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1647483108&t=e5fd4048400832f88cdbf59e49a489b0" class="responsive-img" alt="Redis">
                        
                        <span class="card-title">Redis</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            redis笔记
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-01-15
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Redis/" class="post-category">
                                    Redis
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Redis/">
                        <span class="chip bg-color">Redis</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/01/08/typora-jian-dan-shi-yong/">
                    <div class="card-image">
                        
                        <img src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fpic2.zhimg.com%2Fv2-ce037df0b801b7b96c8b531fabf575e4_1200x500.jpg&refer=http%3A%2F%2Fpic2.zhimg.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1647482549&t=8d96a92ab290edd3325406d78138e179" class="responsive-img" alt="我的第一篇文章">
                        
                        <span class="card-title">我的第一篇文章</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            简单使用Typora
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-01-08
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E6%96%87%E6%9C%AC%E5%B7%A5%E5%85%B7/" class="post-category">
                                    文本工具
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/md/">
                        <span class="chip bg-color">md</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE' || selection.getRangeAt(0).commonAncestorContainer.nodeName === 'CODE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: DTXG的世界<br />'
            + '文章作者: DTXG<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h1, h2, h3'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2022</span>
            
            <a href="/about" target="_blank">DTXG</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">83.9k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br> 

            <!-- 运行天数提醒. -->
            
                <span id="sitetime"> Loading ...</span>
                <script>
                    var calcSiteTime = function () {
                        var seconds = 1000;
                        var minutes = seconds * 60;
                        var hours = minutes * 60;
                        var days = hours * 24;
                        var years = days * 365;
                        var today = new Date();
                        var startYear = "2022";
                        var startMonth = "1";
                        var startDate = "8";
                        var startHour = "2";
                        var startMinute = "4";
                        var startSecond = "22";
                        var todayYear = today.getFullYear();
                        var todayMonth = today.getMonth() + 1;
                        var todayDate = today.getDate();
                        var todayHour = today.getHours();
                        var todayMinute = today.getMinutes();
                        var todaySecond = today.getSeconds();
                        var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                        var diff = t2 - t1;
                        var diffYears = Math.floor(diff / years);
                        var diffDays = Math.floor((diff / days) - diffYears * 365);

                        // 区分是否有年份.
                        var language = 'zh-CN';
                        if (startYear === String(todayYear)) {
                            document.getElementById("year").innerHTML = todayYear;
                            var daysTip = 'This site has been running for ' + diffDays + ' days';
                            if (language === 'zh-CN') {
                                daysTip = '本站已运行 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                daysTip = '本站已運行 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = daysTip;
                        } else {
                            document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                            var yearsAndDaysTip = 'This site has been running for ' + diffYears + ' years and '
                                + diffDays + ' days';
                            if (language === 'zh-CN') {
                                yearsAndDaysTip = '本站已运行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                yearsAndDaysTip = '本站已運行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = yearsAndDaysTip;
                        }
                    }

                    calcSiteTime();
                </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">


    <a href="mailto:2507566674@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2507566674" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 2507566674" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    

    <!-- 雪花特效 -->
     
        <script type="text/javascript">
            // 只在桌面版网页启用特效
            var windowWidth = $(window).width();
            if (windowWidth > 768) {
                document.write('<script type="text/javascript" src="/libs/others/snow.js"><\/script>');
            }
        </script>
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    
    <script type="text/javascript" color="0,0,255"
        pointColor="0,0,255" opacity='0.7'
        zIndex="-1" count="99"
        src="/libs/background/canvas-nest.js"></script>
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
